{% extends "base_generic.html" %}

{% load crispy_forms_tags custom_tags %}

{% block pagetitle %}{{ matrix_title }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'home:dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{{ list_url }}">Matrices</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ matrix_title }}</li>
  </ul>
</nav>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between">
      <div>
        <h4 class="card-title mb-1">{{ matrix_title }}</h4>
        <p class="card-text mb-0">Manage reusable remediation data that can be imported during project artifact processing.</p>
      </div>
      <div class="btn-group mt-3 mt-md-0" role="group" aria-label="Matrix actions">
        {% if create_url %}
          <a class="btn btn-primary icon plus-icon" href="{{ create_url }}">Add entry</a>
        {% endif %}
        {% if export_url %}
          <a class="btn btn-outline-secondary icon export-icon" href="{{ export_url }}">Download CSV</a>
        {% endif %}
      </div>
    </div>

    <hr>

    {% if import_url %}
      <form action="{{ import_url }}" method="post" enctype="multipart/form-data" class="mb-4">
        {% csrf_token %}
        <div class="form-row align-items-end">
          <div class="col-md-6">
            {{ upload_form.csv_file|as_crispy_field }}
            {% if csv_field_names %}
              <small class="form-text text-muted">CSV columns should include: {{ csv_field_names|join:", " }}.</small>
            {% endif %}
          </div>
          <div class="col-md-3 mt-3 mt-md-0">
            <button type="submit" class="btn btn-info icon import-icon">Upload CSV</button>
          </div>
        </div>
      </form>
    {% endif %}

    {% if entries %}
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="matrixTable">
          <thead>
          <tr>
            {% for field, label in table_columns %}
              <th class="text-left">{{ label }}</th>
            {% endfor %}
            {% if edit_url_name %}
              <th class="text-right">Actions</th>
            {% endif %}
          </tr>
          </thead>
          <tbody>
          {% for entry in entries %}
            <tr>
              {% for field, label in table_columns %}
                <td class="text-left">{{ entry|attr:field|default_if_none:""|linebreaksbr }}</td>
              {% endfor %}
              {% if edit_url_name %}
                <td class="text-right">
                  <a class="btn btn-sm btn-outline-primary icon edit-icon" href="{% url edit_url_name entry.pk %}">Edit</a>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% if is_paginated %}
        <nav aria-label="Matrix pagination" class="mt-3">
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
              <a class="page-link" href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}{% else %}#{% endif %}" tabindex="{% if page_obj.has_previous %}0{% else %}-1{% endif %}">Previous</a>
            </li>
            <li class="page-item disabled">
              <span class="page-link">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
            </li>
            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
              <a class="page-link" href="{% if page_obj.has_next %}?page={{ page_obj.next_page_number }}{% else %}#{% endif %}" tabindex="{% if page_obj.has_next %}0{% else %}-1{% endif %}">Next</a>
            </li>
          </ul>
        </nav>
      {% endif %}
    {% else %}
      <div class="alert alert-info" role="alert">
        There are no entries in this matrix yet. Use the buttons above to add a new entry or import a CSV file.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
