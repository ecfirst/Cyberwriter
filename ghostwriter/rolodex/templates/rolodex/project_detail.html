{% extends "base_generic.html" %}

{% load determine_primary bleach_tags custom_tags extra_fields settings_tags %}

{% block pagetitle %}{{ project.client }} {{ project.project_type }} Details{% endblock %}

{% block breadcrumbs %}
  <nav aria-label="breadcrumb">
    <ul class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home:dashboard' %}">Dashboard</a></li>
      <li class="breadcrumb-item"><a data-toggle="tooltip" title="{{ project.client }}"
                                     href="{% url 'rolodex:client_detail' project.client.id %}">{{ project.client.name }}</a>
      </li>
      <li class="breadcrumb-item active"
          aria-current="page">{{ project.start_date|date:"DATE_FORMAT" }} {{ project.project_type }}</li>
    </ul>
  </nav>
{% endblock %}

{% block content %}
  {% if request.user|is_privileged %}
    <div class="dropdown">
      <div class="dropdown-menu-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
           onclick="hamburger(this)">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </div>
      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="project-dropdown-btn">
        <a class="dropdown-item icon edit-icon" href="{% url 'rolodex:project_update' project.id %}">Edit</a>
        <a class="dropdown-item icon trash-icon" href="{% url 'rolodex:project_delete' project.id %}">Delete</a>
      </div>
    </div>
  {% endif %}

  <div class="container offset-col-1 col-10">
    <h2>{{ project.client }} {{ project.project_type }}</h2>
    <h3>{{ project.start_date }}</h3>
  </div>
  {% if project.tags.all %}
    {% for tag in project.tags.names %}<span class="badge badge-secondary">{{ tag|bleach }}</span>{% endfor %}
  {% endif %}
  <hr/>

  <p class="form-spacer"></p>

  <div>
    <ul id="tab-bar" class="nav nav-tabs nav-justified"
        js-update-tabs-url="{% url 'rolodex:ajax_update_project_badges' project.id %}">
      {% include "snippets/project_nav_tabs.html" %}
    </ul>

    <div class="tab-content">
      <div id="planning" class="tab-pane in active">
        <h4>Project Details</h4>
        <hr/>

        <table class="table table-borderless project-details-table offset-2 col-8">
          <tr>
            <td class="text-left bold">Project Status</td>
            <td class="text-left">
              <span data-toggle="tooltip"
                    title="Toggle the project's status between executing and complete">
                {% if project.complete %}
                  <a href="javascript:void(0)" class="clickable-link js-toggle-project-status"
                     toggle-project-status-csrftoken="{{ csrf_token }}"
                     toggle-project-status-url="{% url 'rolodex:ajax_toggle_project' project.id %}"
                     toggle-project-status-id="{{ project.id }}">
                    <i id="js-toggle-project-status-icon" class="fas fa-toggle-on"></i>
                    <span id="js-project-status">Complete</span>
                  </a>
                {% else %}
                  <a href="javascript:void(0)" class="clickable-link js-toggle-project-status"
                     toggle-project-status-csrftoken="{{ csrf_token }}"
                     toggle-project-status-url="{% url 'rolodex:ajax_toggle_project' project.id %}"
                     toggle-project-status-id="{{ project.id }}">
                    <i id="js-toggle-project-status-icon" class="fas fa-toggle-off"></i>
                    <span id="js-project-status">In Progress</span>
                  </a>
                {% endif %}
              </span>
            </td>
          </tr>
          <tr>
            <td class="text-left bold">Codename</td>
            <td class="text-left">
              {% if project.codename %} {{ project.codename }} {% else %} No Codename {% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-left bold">Execution Dates</td>
            <td class="text-left">{{ project.start_date|date:"DATE_FORMAT" }}
              â€“ {{ project.end_date|date:"DATE_FORMAT" }}</td>
          </tr>
          <tr>
            <td class="text-left bold">Working Hours</td>
            <td class="text-left">
              {% if project.start_time and project.end_time %} {{ project.start_time|date:"G:i" }} to
                {{ project.end_time|date:"G:i" }} ({{ project.timezone }}) {% else %} No Working Hours Set {% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-left bold">Slack Channel</td>
            <td class="text-left">
              {% if project.slack_channel %} {{ project.slack_channel }} {% else %} No Slack Channel {% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-left bold">Project Description</td>
            <td class="text-left">
              <a href="javascript:void(0);" id="projectDescriptionDropdown" class="align-icon icon add-icon">Show
                Description</a>
            </td>
          </tr>
        </table>

        <div id="projectDescription" class="description-block offset-md-2 col-8">
          {% if project.note %}
            {{ project.note|bleach }}
          {% else %}
            <p class="text-center">No one has added a description of this project. <a class="clickable"
                                                                                      href="{% url 'rolodex:project_update' project.id %}">Fix
              that here.
            </a>
            </p>
          {% endif %}
        </div>

        <div class="hidden-element"></div>
      </div>

      <div id="workbook" class="tab-pane">
        <h4>Workbook</h4>
        <hr/>

        {% if report_data_record.workbook %}
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Current Workbook</h5>
              <p class="card-text mb-1">Uploaded {{ report_data_record.workbook_uploaded_at|date:"DATETIME_FORMAT" }}.</p>
              <a class="btn btn-outline-primary btn-sm" href="{{ report_data_record.workbook.url }}" target="_blank">
                Download Workbook
              </a>
            </div>
          </div>
        {% else %}
          <div class="alert alert-info" role="alert">
            No workbook has been uploaded for this project yet.
          </div>
        {% endif %}

        <form action="{% url 'rolodex:project_workbook_upload' project.pk %}" method="post"
              enctype="multipart/form-data" class="mt-3">
          {% csrf_token %}
          <div class="form-group">
            <label for="id_workbook">Upload Workbook (JSON)</label>
            <input type="file" name="workbook" id="id_workbook" accept="application/json" class="form-control-file"
                   required>
            <small class="form-text text-muted">Uploading a new workbook will replace the existing file.</small>
          </div>
          <button type="submit" class="btn btn-primary">Upload Workbook</button>
        </form>
      </div>

      <div id="data" class="tab-pane">
        <h4>Report Data</h4>
        <hr/>

        {% if not report_data_record.workbook %}
          <div class="alert alert-info" role="alert">
            Upload a workbook to unlock the data collection workflow.
          </div>
        {% else %}
          <section class="mb-4">
            <h5>Required Data Files</h5>
            {% if report_required_files %}
              {% for requirement in report_required_files %}
                <div class="card mb-3">
                  <div class="card-body">
                    <h6 class="card-title">{{ requirement.label }}</h6>
                    {% if requirement.artifacts %}
                      <ul class="list-unstyled mb-2">
                        {% for artifact in requirement.artifacts %}
                          <li class="d-flex align-items-center justify-content-between flex-wrap">
                            <a href="{{ artifact.file.url }}" target="_blank">{{ artifact.label }}</a>
                            <form method="post"
                                  action="{% url 'rolodex:project_artifact_delete' project.pk artifact.pk %}"
                                  class="d-inline-block">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-link btn-sm text-danger p-0">Remove</button>
                            </form>
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <p class="text-muted mb-2">No file uploaded.</p>
                    {% endif %}
                    <form action="{% url 'rolodex:project_artifact_upload' project.pk %}" method="post"
                          enctype="multipart/form-data"
                          class="d-flex flex-column flex-md-row gap-2 align-items-start">
                      {% csrf_token %}
                      <input type="hidden" name="category" value="{{ requirement.slug }}">
                      <input type="hidden" name="label" value="{{ requirement.label }}">
                      <div class="form-group mb-2 mb-md-0 mr-md-3">
                        <input type="file" name="file" class="form-control-file" required>
                      </div>
                      <button type="submit" class="btn btn-secondary">Upload</button>
                    </form>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No additional files are required for this workbook.</p>
            {% endif %}
          </section>

          <section class="mb-4">
            <h5>Additional Attachments</h5>
            <form action="{% url 'rolodex:project_artifact_upload' project.pk %}" method="post"
                  enctype="multipart/form-data"
                  class="row g-2 align-items-end">
              {% csrf_token %}
              <input type="hidden" name="category" value="additional">
              <div class="form-group col-md-4">
                <label for="id_additional_label">Label</label>
                <input type="text" name="label" id="id_additional_label" class="form-control" required>
              </div>
              <div class="form-group col-md-4">
                <label for="id_additional_file">File</label>
                <input type="file" name="file" id="id_additional_file" class="form-control-file" required>
              </div>
              <div class="form-group col-md-4">
                <button type="submit" class="btn btn-secondary">Upload Attachment</button>
              </div>
            </form>
            {% if report_artifacts_additional %}
              <ul class="list-unstyled mt-3">
                {% for artifact in report_artifacts_additional %}
                  <li class="d-flex align-items-center justify-content-between flex-wrap">
                    <a href="{{ artifact.file.url }}" target="_blank">{{ artifact.label }}</a>
                    <form method="post"
                          action="{% url 'rolodex:project_artifact_delete' project.pk artifact.pk %}"
                          class="d-inline-block">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-link btn-sm text-danger p-0">Remove</button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </section>

          <section>
            <h5>Reporting Questions</h5>
            {% if report_questions_available %}
              <form action="{% url 'rolodex:project_report_data_update' project.pk %}" method="post">
                {% csrf_token %}
                {% for group, questions in report_question_groups.items %}
                  <div class="card mb-3">
                    <div class="card-header">{{ group }}</div>
                    <div class="card-body">
                      {% for question in questions %}
                        <div class="form-group">
                          <label for="id_{{ question.key }}">{{ question.label }}</label>
                          {% if question.help_text %}
                            <p class="small text-muted mb-1">{{ question.help_text }}</p>
                          {% endif %}
                          {% if question.type == "text" %}
                            <input type="text" class="form-control" id="id_{{ question.key }}"
                                   name="{{ question.key }}"
                                   value="{{ question.value|default_if_none:'' }}">
                          {% elif question.type == "choice" or question.type == "boolean" %}
                            <select class="form-control" id="id_{{ question.key }}" name="{{ question.key }}">
                              <option value="">---------</option>
                              {% for choice in question.choices %}
                                <option value="{{ choice.value }}"
                                  {% if question.value == choice.value %}selected{% endif %}>{{ choice.label }}</option>
                              {% endfor %}
                            </select>
                          {% elif question.type == "multi_choice" %}
                            <div>
                              {% for choice in question.choices %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" value="{{ choice.value }}"
                                         id="id_{{ question.key }}_{{ forloop.counter }}"
                                         name="{{ question.key }}"
                                         {% if question.value and choice.value in question.value %}checked{% endif %}>
                                  <label class="form-check-label"
                                         for="id_{{ question.key }}_{{ forloop.counter }}">{{ choice.label }}</label>
                                </div>
                              {% endfor %}
                            </div>
                          {% elif question.type == "number" %}
                            <input type="number" class="form-control" id="id_{{ question.key }}"
                                   name="{{ question.key }}"
                                   {% if question.min_value is not None %}min="{{ question.min_value }}"{% endif %}
                                   value="{{ question.value|default_if_none:'' }}">
                          {% elif question.type == "list_text" %}
                            <div class="list-input-container" data-input-name="{{ question.key }}">
                              <div class="list-input-items">
                                {% if question.value %}
                                  {% for entry in question.value %}
                                    <div class="input-group mb-2">
                                      <input type="text" class="form-control" name="{{ question.key }}"
                                             value="{{ entry }}">
                                      <div class="input-group-append">
                                        <button class="btn btn-outline-danger remove-list-item" type="button">&times;</button>
                                      </div>
                                    </div>
                                  {% endfor %}
                                {% else %}
                                  <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="{{ question.key }}">
                                    <div class="input-group-append">
                                      <button class="btn btn-outline-danger remove-list-item" type="button">&times;</button>
                                    </div>
                                  </div>
                                {% endif %}
                              </div>
                              <button class="btn btn-sm btn-outline-secondary add-list-item" type="button">Add another</button>
                            </div>
                          {% elif question.type == "risk_matrix" %}
                            <div class="row">
                              {% for row in question.rows %}
                                <div class="col-md-6">
                                  <div class="form-group">
                                    <label for="id_{{ question.key }}__{{ row.key }}">{{ row.label }}</label>
                                    <select class="form-control" id="id_{{ question.key }}__{{ row.key }}"
                                            name="{{ question.key }}__{{ row.key }}">
                                      <option value="">---------</option>
                                      {% for choice in question.choices %}
                                        <option value="{{ choice.value }}"
                                          {% if row.selected == choice.value %}selected{% endif %}>{{ choice.label }}</option>
                                      {% endfor %}
                                    </select>
                                  </div>
                                </div>
                              {% endfor %}
                            </div>
                          {% elif question.type == "boolean_with_followup" %}
                            <select class="form-control" id="id_{{ question.key }}" name="{{ question.key }}"
                                    data-followup-target="{{ question.followup.key }}">
                              <option value="">---------</option>
                              {% for choice in question.choices %}
                                <option value="{{ choice.value }}"
                                  {% if question.value == choice.value %}selected{% endif %}>{{ choice.label }}</option>
                              {% endfor %}
                            </select>
                            <div class="mt-3 list-input-container"
                                 data-followup-group="{{ question.followup.key }}"
                                 {% if question.value != 'yes' %}style="display:none"{% endif %}>
                              <label class="font-weight-bold" for="id_{{ question.followup.key }}">{{ question.followup.label }}</label>
                              <div class="list-input-items">
                                {% if question.followup_value %}
                                  {% for entry in question.followup_value %}
                                    <div class="input-group mb-2">
                                      <input type="text" class="form-control" name="{{ question.followup.key }}"
                                             value="{{ entry }}">
                                      <div class="input-group-append">
                                        <button class="btn btn-outline-danger remove-list-item" type="button">&times;</button>
                                      </div>
                                    </div>
                                  {% endfor %}
                                {% else %}
                                  <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="{{ question.followup.key }}">
                                    <div class="input-group-append">
                                      <button class="btn btn-outline-danger remove-list-item" type="button">&times;</button>
                                    </div>
                                  </div>
                                {% endif %}
                              </div>
                              <button class="btn btn-sm btn-outline-secondary add-list-item" type="button">Add another</button>
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
                <button type="submit" class="btn btn-primary">Save Responses</button>
              </form>
            {% else %}
              <p class="text-muted">No additional questions are required for this workbook.</p>
            {% endif %}
          </section>
        {% endif %}
      </div>

      <div id="documents" class="tab-pane ">
        <h4>Generate Project Documents</h4>
        <hr/>

        <p class="text-justify offset-2 col-8">
          Generate JSON with project data or select a template to generate a project document (e.g., SOW, ROE).
        </p>
        <p class="text-justify offset-2 col-8">
          No report data is available to these templates, so only the Word templates that are marked as project templates will be available.
        </p>

        <div class="input-group mb-3 offset-2 col-8">
          <div class="input-group-prepend">
            <span class="input-group-text" id="projectExportFilename">Options</span>
          </div>
          <select class="form-control form-select custom-select" id="projectExportSelector" data-url="{% url 'rolodex:ajax_project_generate_report' project.pk 'replaceme' %}">
            <option value="json">JSON</option>
            {% for template in export_templates %}
              <option value="{{ template.pk }}">{{ template.name }} ({{ template.doc_type.extension }})</option>
            {% endfor %}
          </select>
          <span class="input-group-append">
            <button id="projectExportButton" class="btn btn-outline-primary">Generate</button>
          </span>
        </div>

        <h4>Project Reports & Findings</h4>
        <hr/>

        {% if project.complete %}
          <p>The project is marked as complete so no additional reports may be created.</p>
        {% else %}
          <a class="icon add-icon btn btn-primary mb-3 col-3" href="{% url 'reporting:report_create' project.id %}">Add
            a Report</a>
        {% endif %}

        <p>View and edit findings by opening the related report (click the link).</p>

        {% if project.report_set.all %}
          <table id="reportTable" class="table">
            <thead>
            <th class="align-middle pr-4 text-left">Title</th>
            <th class="align-middle pr-4 text-left">Status</th>
            <th class="align-middle pr-4 text-left">Last Update</th>
            <th class="align-middle pr-4 text-left">Created By</th>
            <th class="sorter-false text-center align-middle">Options</th>
            </thead>
            {% for report in project.report_set.all %}
              <tr>
                <td class="align-middle text-left"><a class="clickable"
                                            href="{{ report.get_absolute_url }}">{{ report.title }}</a></td>
                {% if report.complete %}
                  {% if report.delivered %}
                    <td class="align-middle text-left">Delivered</td>
                  {% else %}
                    <td class="align-middle text-left">Complete, Awaiting Delivery</td>
                  {% endif %}
                {% else %}
                  <td class="align-middle text-left">In Progress</td>
                {% endif %}
                <td class="align-middle text-left">{{ report.last_update|date:"DATE_FORMAT" }}</td>
                <td class="align-middle text-left">{{ report.created_by }}</td>

                <td class="align-middle">
                  <div class="d-flex justify-content-center">
                    <a title="Set this report as your active report" href="javascript:void(0)"
                       data-toggle="tooltip"
                       data-placement="top"
                       class="clickable-link js-activate-report icon power-icon"
                       activate-report-csrftoken="{{ csrf_token }}"
                       activate-report-url="{% url 'reporting:ajax_activate_report' report.id %}"
                       activate-report-id="{{ report.id }}"></a>
                    <a class="icon clone-icon"
                       data-toggle="tooltip"
                       data-placement="top"
                       title="Make a copy of this report on this project"
                       href="{% url 'reporting:report_clone' report.id %}"></a>
                    <a class="icon archive-icon"
                       data-toggle="tooltip"
                       data-placement="top"
                       title="Archive this report"
                       href="{% url 'reporting:archive' report.id %}"></a>
                    <a class="icon trash-icon"
                       data-toggle="tooltip"
                       data-placement="top"
                       title="Delete this report"
                       href="{% url 'reporting:report_delete' report.id %}"></a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </table>
        {% else %}
          <div class="alert alert-warning offset-md-2 col-md-8 mt-3" role="alert">There are no reports for this project.</div>
        {% endif %}
      </div>

      {% if project_extra_fields_spec %}
        <div id="extra_fields" class="tab-pane ">
          <h4>Extra Fields</h4>
          <hr/>

          <a class="icon edit-icon btn btn-primary mb-1 col-3"
            href="{% url 'rolodex:project_component_update' project.id %}#extra-fields">Edit Extra Fields</a>

          {% include "user_extra_fields/field_preview_display.html" with object=project object_extra_fields_spec=project_extra_fields_spec %}

        </div>
      {% endif %}

      <div id="notes" class="tab-pane">
        <h4>Project Notes</h4>
        <hr/>

        <a class="icon add-icon btn btn-primary mb-3 col-3" href="{% url 'rolodex:project_note_add' project.id %}">Add a
          Note</a>

        {% if project.projectnote_set.all %}
          {% for note in project.projectnote_set.all reversed %}
            <div id="note-container-{{ note.id }}">
              <div class="container note-container {% if forloop.counter|divisibleby:2 %}darker{% endif %}">
                <div class="float-left col-10 col-md-10 col-sm-8">
                  {{ note.note|bleach }}
                </div>

                <div class="float-right col-2 col-md-2 col-sm-4">
                  <div>{% if note.operator %}<a class="note-link"
                                                href="{% url 'users:user_detail' note.operator.username %}">{{ note.operator.username }}</a>{% else %}
                    <span class="note-link">Deleted</span>{% endif %}</div>
                  <div><p class="note-time">{{ note.timestamp }}</p></div>
                </div>
              </div>
            </div>

            {% if request.user == note.operator or request.user|is_privileged %}
              <div class="pb-3">
                <a class="note-link" href="{% url 'rolodex:project_note_edit' note.id %}">Edit</a> |
                <a id="note-delete-button-{{ note.id }}" class="js-confirm-delete note-link" data-toggle="modal"
                   data-target="#confirm-delete-modal" href="javascript:void(0);"
                   delete-target-csrftoken="{{ csrf_token }}"
                   delete-target-url="{% url 'rolodex:ajax_delete_project_note' note.id %}"
                   delete-target-id="{{ note.id }}" delete-target-type="note">Delete</a>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="alert alert-warning offset-md-2 col-md-8 mt-1" role="alert">There are no notes for this project.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% include "confirm_delete_modal.html" %}

  {% if project_extra_fields_spec %}
    {% for field_spec in project_extra_fields_spec %}
      {% include "user_extra_fields/extra_field_modal.html" with extra_fields=project.extra_fields field_spec=field_spec %}
    {% endfor %}
  {% endif %}
{% endblock %}

{% block tabs %}
  {{ block.super }}
{% endblock %}

{% block morescripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const description = document.getElementById('projectDescription');
      const toggle = document.getElementById('projectDescriptionDropdown');
      if (description && toggle) {
        description.style.display = 'none';
        toggle.addEventListener('click', function () {
          if (description.style.display === 'none') {
            description.style.display = 'block';
            toggle.classList.remove('add-icon');
            toggle.classList.add('sub-icon');
          } else {
            description.style.display = 'none';
            toggle.classList.remove('sub-icon');
            toggle.classList.add('add-icon');
          }
        });
      }

      document.querySelectorAll('.add-list-item').forEach(function (button) {
        button.addEventListener('click', function () {
          const container = button.closest('.list-input-container');
          if (!container) { return; }
          const items = container.querySelector('.list-input-items');
          if (!items) { return; }
          const inputName = container.getAttribute('data-input-name');
          const wrapper = document.createElement('div');
          wrapper.className = 'input-group mb-2';
          const input = document.createElement('input');
          input.type = 'text';
          input.name = inputName;
          input.className = 'form-control';
          const append = document.createElement('div');
          append.className = 'input-group-append';
          const remove = document.createElement('button');
          remove.type = 'button';
          remove.className = 'btn btn-outline-danger remove-list-item';
          remove.innerHTML = '&times;';
          append.appendChild(remove);
          wrapper.appendChild(input);
          wrapper.appendChild(append);
          items.appendChild(wrapper);
          remove.addEventListener('click', function () {
            wrapper.remove();
          });
        });
      });

      document.querySelectorAll('.remove-list-item').forEach(function (button) {
        button.addEventListener('click', function () {
          const group = button.closest('.input-group');
          if (group) {
            group.remove();
          }
        });
      });

      document.querySelectorAll('[data-followup-target]').forEach(function (select) {
        const followupKey = select.getAttribute('data-followup-target');
        const container = document.querySelector('[data-followup-group="' + followupKey + '"]');
        if (!container) { return; }
        const updateVisibility = function () {
          if (select.value === 'yes') {
            container.style.display = '';
          } else {
            container.style.display = 'none';
            container.querySelectorAll('input[type="text"]').forEach(function (input) {
              input.value = '';
            });
          }
        };
        select.addEventListener('change', updateVisibility);
        updateVisibility();
      });

      const exportSelector = document.getElementById('projectExportSelector');
      const exportButton = document.getElementById('projectExportButton');
      if (exportSelector && exportButton) {
        exportButton.addEventListener('click', function () {
          const urlTemplate = exportSelector.getAttribute('data-url');
          if (!urlTemplate) { return; }
          const url = urlTemplate.replace('replaceme', exportSelector.value);
          window.location = url;
        });
      }
    });
  </script>
{% endblock %}
