{% extends "base_generic.html" %}

{% load determine_primary bleach_tags custom_tags extra_fields settings_tags %}

{% block pagetitle %}{{ project.client }} {{ project.project_type }} Details{% endblock %}

{% block breadcrumbs %}
  <nav aria-label="breadcrumb">
    <ul class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home:dashboard' %}">Dashboard</a></li>
      <li class="breadcrumb-item"><a data-toggle="tooltip" title="{{ project.client }}"
                                     href="{% url 'rolodex:client_detail' project.client.id %}">{{ project.client.name }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ project.start_date|date:"DATE_FORMAT" }} {{ project.project_type }}</li>
    </ul>
  </nav>
{% endblock %}

{% block content %}
  {% if request.user|is_privileged %}
    <div class="dropdown">
      <div class="dropdown-menu-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
           onclick="hamburger(this)">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </div>
      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="project-dropdown-btn">
        <a class="dropdown-item icon edit-icon" href="{% url 'rolodex:project_update' project.id %}">Edit</a>
        <a class="dropdown-item icon trash-icon" href="{% url 'rolodex:project_delete' project.id %}">Delete</a>
      </div>
    </div>
  {% endif %}

  <div class="container offset-col-1 col-10">
    <h2>{{ project.client }} {{ project.project_type }}</h2>
    <h3>{{ project.start_date }}</h3>
  </div>
  {% if project.tags.all %}
    {% for tag in project.tags.names %}<span class="badge badge-secondary">{{ tag|bleach }}</span>{% endfor %}
  {% endif %}
  <hr/>

  <p class="form-spacer"></p>

  <div>
    <ul id="tab-bar" class="nav nav-tabs nav-justified"
        js-update-tabs-url="{% url 'rolodex:ajax_update_project_badges' project.id %}">
      {% include "snippets/project_nav_tabs.html" %}
    </ul>

    <div class="tab-content">
      <div id="overview" class="tab-pane in active">
        <h4>Project Details</h4>
        <hr/>

        <table class="table table-borderless project-details-table offset-2 col-8">
          <tr>
            <td class="text-left bold">Project Status</td>
            <td class="text-left">
              <span data-toggle="tooltip" title="Toggle the project's status between executing and complete">
                {% if project.complete %}
                  <a href="javascript:void(0)" class="clickable-link js-toggle-project-status"
                     toggle-project-status-csrftoken="{{ csrf_token }}"
                     toggle-project-status-url="{% url 'rolodex:ajax_toggle_project' project.id %}"
                     toggle-project-status-id="{{ project.id }}">
                    <i id="js-toggle-project-status-icon" class="fas fa-toggle-on"></i>
                    <span id="js-project-status">Complete</span>
                  </a>
                {% else %}
                  <a href="javascript:void(0)" class="clickable-link js-toggle-project-status"
                     toggle-project-status-csrftoken="{{ csrf_token }}"
                     toggle-project-status-url="{% url 'rolodex:ajax_toggle_project' project.id %}"
                     toggle-project-status-id="{{ project.id }}">
                    <i id="js-toggle-project-status-icon" class="fas fa-toggle-off"></i>
                    <span id="js-project-status">In Progress</span>
                  </a>
                {% endif %}
              </span>
            </td>
          </tr>
          <tr>
            <td class="text-left bold">Codename</td>
            <td class="text-left">{% if project.codename %}{{ project.codename }}{% else %}No Codename{% endif %}</td>
          </tr>
          <tr>
            <td class="text-left bold">Execution Dates</td>
            <td class="text-left">{{ project.start_date|date:"DATE_FORMAT" }} â€“ {{ project.end_date|date:"DATE_FORMAT" }}</td>
          </tr>
          <tr>
            <td class="text-left bold">Working Hours</td>
            <td class="text-left">
              {% if project.start_time and project.end_time %}
                {{ project.start_time|date:"G:i" }} to {{ project.end_time|date:"G:i" }} ({{ project.timezone }})
              {% else %}
                No Working Hours Set
              {% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-left bold">Slack Channel</td>
            <td class="text-left">{% if project.slack_channel %}{{ project.slack_channel }}{% else %}No Slack Channel{% endif %}</td>
          </tr>
          <tr>
            <td class="text-left bold">Project Description</td>
            <td class="text-left">
              <a href="javascript:void(0);" id="projectDescriptionDropdown" class="align-icon icon add-icon">Show Description</a>
            </td>
          </tr>
        </table>

        <div id="projectDescription" class="description-block offset-md-2 col-8">
          {% if project.note %}
            {{ project.note|bleach }}
          {% else %}
            <p class="text-center">No one has added a description of this project. <a class="clickable"
                                                                                          href="{% url 'rolodex:project_update' project.id %}">Add one here.</a></p>
          {% endif %}
        </div>

        <div class="hidden-element"></div>

        <h4>Project Timeline</h4>
        <hr/>
        <div id="project-calendar" data-start="{{ project.start_date|date:'Y-m-d' }}"
             data-end="{{ project.end_date|date:'Y-m-d' }}"></div>
      </div>

      <div id="workbook" class="tab-pane" data-workbook-update-url="{% url 'rolodex:project_workbook_data_update' project.id %}">
        <h4>Workbook</h4>
        <hr/>
        <div class="row mb-3">
          <div class="col-12">
            <div class="card-deck flex-column flex-md-row">
              <div class="card workbook-entry-card mb-3" role="button" data-toggle="modal" data-target="#workbookScoringModal">
                <div class="card-body text-center">
                  <h5 class="card-title mb-1">Scoring</h5>
                  <p class="card-text small mb-0">Enter scores for each in-scope area</p>
                  <div class="progress workbook-card-progress mt-2">
                    <div class="progress-bar" id="workbook-progress-scoring" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
              <div class="card workbook-entry-card mb-3" role="button" data-toggle="modal" data-target="#workbookGradesModal">
                <div class="card-body text-center">
                  <h5 class="card-title mb-1">Grades</h5>
                  <p class="card-text small mb-0">Review and adjust risk labels</p>
                  <div class="progress workbook-card-progress mt-2">
                    <div class="progress-bar" id="workbook-progress-grades" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
              <div class="card workbook-entry-card mb-3" role="button" data-toggle="modal" data-target="#workbookGeneralModal">
                <div class="card-body text-center">
                  <h5 class="card-title mb-1">General</h5>
                  <p class="card-text small mb-0">Capture schedule and environment details</p>
                  <div class="progress workbook-card-progress mt-2">
                    <div class="progress-bar" id="workbook-progress-general" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-12" id="workbook-area-cards"></div>
        </div>
        <div class="row justify-content-center">
          <div class="col-12 col-xl-11">
            <p class="text-justify">
              Upload the JSON workbook that powers the reporting workflow. Uploading a new workbook will replace the existing file
              and refresh the dynamic questions on the Data tab.
            </p>
            <form id="project-workbook-form" method="post"
                  action="{% url 'rolodex:project_workbook' project.id %}"
                  enctype="multipart/form-data">
              {% csrf_token %}
              <div class="form-group">
                <label for="id_workbook_file">{{ workbook_form.workbook_file.label }}</label>
                {{ workbook_form.workbook_file }}
              </div>
              <button type="submit" class="btn btn-primary" data-default-text="Upload Workbook">Upload Workbook</button>
            </form>

            {% if project.workbook_file %}
              <div class="alert alert-secondary mt-4">
                <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
                  <div>
                    <strong>Current workbook:</strong>
                    <a href="{{ project.workbook_file.url }}" download>{{ project.workbook_file.name|cut:"project_workbooks/"|default_if_none:"workbook.json" }}</a>
                  </div>
                  <form method="post" action="{% url 'rolodex:project_workbook' project.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="clear_workbook" value="1"/>
                    <button type="submit" class="btn btn-outline-danger btn-sm">Remove Workbook</button>
                  </form>
                </div>
              </div>
              {% if not workbook_sections %}
                <div class="alert alert-info mt-4">
                  Workbook uploaded successfully. No preview data is available for this workbook yet.
                </div>
              {% endif %}
            {% else %}
              <div class="alert alert-warning mt-4">No workbook has been uploaded yet.</div>
            {% endif %}

            {% if workbook_sections %}
              <div class="mt-4">
                <h5>Workbook Data</h5>
              </div>
              <div>
                {% for section in workbook_sections %}
                  <div class="card mb-3">
                    <div class="card-header font-weight-bold">{{ section.title }}</div>
                    <div class="card-body">
                      {% include "rolodex/includes/workbook_value.html" with node=section.tree %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
        <div id="workbook-area-modals"></div>
        <div class="modal fade" id="workbookGeneralModal" tabindex="-1" role="dialog" aria-labelledby="workbookGeneralLabel"
             aria-hidden="true">
          <div class="modal-dialog modal-xl workbook-modal" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="workbookGeneralLabel">General Workbook Data</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div id="workbook-general-fields" class="row"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveGeneralWorkbookData">Save General Data</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="workbookScoringModal" tabindex="-1" role="dialog" aria-labelledby="workbookScoringLabel"
             aria-hidden="true">
          <div class="modal-dialog modal-xl workbook-modal" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="workbookScoringLabel">Scoring</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <p class="small text-muted">Scoring: 1-2~=Low; 2-4~=Medium; 4-6~=High</p>
                <div id="workbook-scoring-groups" class="row"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveScoringWorkbookData">Save Scoring</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="workbookGradesModal" tabindex="-1" role="dialog" aria-labelledby="workbookGradesLabel"
             aria-hidden="true">
          <div class="modal-dialog modal-xl workbook-modal" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="workbookGradesLabel">Grades</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-8" id="workbook-grades-fields"></div>
                  <div class="col-md-4 mt-3 mt-md-0" id="risk-score-legend"></div>
                </div>
              </div>
              <div class="modal-footer d-flex flex-column flex-md-row align-items-stretch align-items-md-center justify-content-between">
                <div class="mb-2 mb-md-0">
                  <button type="button" class="btn btn-outline-primary mr-2" id="adjustGradeOverall">Adjust</button>
                  <button type="button" class="btn btn-outline-secondary" id="resetGradeValues">Reset</button>
                </div>
                <div>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id="saveGradeWorkbookData">Save Grades</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        {{ workbook_data_json|json_script:"project-workbook-data" }}
        {{ project_data_artifacts_json|json_script:"project-data-artifacts" }}
        {{ project_scoping_json|json_script:"project-scoping-data" }}
        {{ project_scoping_weights_json|json_script:"project-scoping-weights" }}
        {{ project_scoping_config_json|json_script:"project-scoping-config" }}
        {{ risk_score_map_json|json_script:"project-risk-score-map" }}
      </div>

      <div id="supplementals" class="tab-pane">
        <h4>Additional Data Files</h4>
        <hr/>
        {% if supplemental_cards %}
          <div class="offset-2 col-8 mb-4">
            <h5>Required Artifacts</h5>
            {% for card in supplemental_cards %}
              {% if card.card_type == 'required' %}
                {% with requirement=card.data %}
                  <div class="card mb-3">
                    <div class="card-body">
                      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="mb-3 mb-md-0">
                          <h6 class="mb-1">
                            {{ requirement.label }}
                            {% if requirement.context %}
                              <small class="text-muted">for {{ requirement.context }}</small>
                            {% endif %}
                          </h6>
                          {% if requirement.missing_matrix_entries %}
                            <div class="alert alert-warning small py-2 px-3 mt-2">
                              Missing Nexpose issues identified! Update the matrix and re-upload.
                            </div>
                          {% endif %}
                          {% if requirement.missing_web_matrix_entries %}
                            <div class="alert alert-warning small py-2 px-3 mt-2">
                              Missing Web issues identified! Update the matrix and re-upload.
                            </div>
                          {% endif %}
                            {% if requirement.existing %}
                              <p class="mb-1">
                                <strong>Current file:</strong>
                                <a href="{{ requirement.existing.file.url }}" download>{{ requirement.existing.filename }}</a>
                              </p>
                              {% if requirement.parsed_fail_count is not None %}
                                <p class="mb-0 text-muted small">Failed checks detected: {{ requirement.parsed_fail_count }}</p>
                              {% endif %}
                              <form
                                method="post"
                                class="d-inline project-data-file-delete-form"
                                action="{% url 'rolodex:project_data_file_delete' pk=requirement.existing.pk %}"
                                data-success-url="{{ request.path }}#supplementals"
                              >
                                {% csrf_token %}
                                <input type="hidden" name="project_id" value="{{ project.id }}"/>
                                <input type="hidden" name="requirement_slug" value="{{ requirement.slug|default:'' }}"/>
                                <button
                                  type="submit"
                                  class="btn btn-outline-danger btn-sm project-data-file-delete-button"
                                >
                                  Remove
                                </button>
                              </form>
                            {% else %}
                              <p class="mb-1 text-muted">No file uploaded yet.</p>
                          {% endif %}
                        </div>
                        <form method="post" action="{% url 'rolodex:project_data_file_upload' project.id %}" enctype="multipart/form-data" class="w-100 w-md-auto project-required-data-form">
                          {% csrf_token %}
                          <input type="hidden" name="requirement_slug" value="{{ requirement.slug }}"/>
                          <input type="hidden" name="requirement_label" value="{{ requirement.label }}"/>
                          <input type="hidden" name="requirement_context" value="{{ requirement.context|default:'' }}"/>
                          <input type="hidden" name="description" value=""/>
                          <div class="form-group mb-2">
                            <label class="sr-only" for="id_required_file_{{ requirement.slug }}">{{ requirement.label }}{% if requirement.context %} for {{ requirement.context }}{% endif %}</label>
                            <input type="file" name="file" class="form-control-file project-required-data-input" id="id_required_file_{{ requirement.slug }}" accept=".csv,.xml,text/csv,application/xml,text/xml" required>
                          </div>
                            <div class="d-flex flex-column flex-md-row align-items-md-center">
                              <button type="submit" class="btn btn-primary btn-sm" data-default-text="Upload">Upload</button>
                              {% if requirement.missing_matrix_entries and requirement.artifact_key %}
                                <a
                                  href="{% url 'rolodex:project_nexpose_missing_download' project.id %}?artifact={{ requirement.artifact_key }}"
                                  class="btn btn-outline-warning btn-sm mt-2 mt-md-0 ml-md-2"
                                >
                                  Download Missing
                                </a>
                              {% elif requirement.missing_web_matrix_entries %}
                                <a
                                  href="{% url 'rolodex:project_web_issue_missing_download' project.id %}"
                                  class="btn btn-outline-warning btn-sm mt-2 mt-md-0 ml-md-2"
                                >
                                  Download Missing
                                </a>
                              {% endif %}
                            </div>
                          </form>
                        </div>
                    </div>
                  </div>
                {% endwith %}
              {% elif card.card_type == 'ip' %}
                {% with ip_card=card.data %}
                  <div class="card mb-3">
                    <div class="card-body">
                      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="mb-3 mb-md-0 w-100">
                          <h6 class="mb-1">{{ ip_card.label }}</h6>
                          {% if ip_card.ip_count %}
                            <p class="mb-1 text-muted">Currently stored: {{ ip_card.ip_count }} IP{% if ip_card.ip_count != 1 %}s{% endif %}.</p>
                          {% endif %}
                          {% if ip_card.existing %}
                            <p class="mb-1">
                              <strong>Current list:</strong>
                              <a href="{{ ip_card.existing.file.url }}" download>{{ ip_card.existing.filename }}</a>
                            </p>
                            <form
                              method="post"
                              class="d-inline project-data-file-delete-form"
                              action="{% url 'rolodex:project_data_file_delete' pk=ip_card.existing.pk %}"
                              data-success-url="{{ request.path }}#supplementals"
                            >
                              {% csrf_token %}
                              <input type="hidden" name="project_id" value="{{ project.id }}"/>
                              <input type="hidden" name="requirement_slug" value="{{ ip_card.slug|default:'' }}"/>
                              <button
                                type="submit"
                                class="btn btn-outline-danger btn-sm project-data-file-delete-button"
                              >
                                Remove
                              </button>
                            </form>
                          {% else %}
                            <p class="mb-1 text-muted">No IP addresses provided yet.</p>
                          {% endif %}
                        </div>
                        <form method="post" action="{% url 'rolodex:project_ip_artifact_upload' project.id %}" enctype="multipart/form-data" class="w-100 w-md-auto project-ip-artifact-form">
                          {% csrf_token %}
                          <input type="hidden" name="ip_type" value="{{ ip_card.type }}"/>
                          <div class="form-group mb-2 w-100">
                            <label for="id_ip_text_{{ ip_card.slug }}">Paste IP Addresses</label>
                            <textarea name="ip_text" id="id_ip_text_{{ ip_card.slug }}" class="form-control no-auto-tinymce" rows="5" placeholder="One IP address per line"></textarea>
                            <small class="form-text text-muted">You may paste IPs, upload a file, or provide both.</small>
                          </div>
                          <div class="form-group mb-2">
                            <label class="sr-only" for="id_ip_file_{{ ip_card.slug }}">Upload Plain Text</label>
                            <input type="file" name="ip_file" class="form-control-file project-ip-file-input" id="id_ip_file_{{ ip_card.slug }}" accept=".txt,text/plain">
                            <small class="form-text text-muted">Upload a text file containing one IP address per line.</small>
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm" data-default-text="Save">Save</button>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endwith %}
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-info offset-2 col-8 mt-4">No additional data files have been requested for this project.</div>
        {% endif %}
      </div>

      <div id="data" class="tab-pane">
        <h4>Questionnaire</h4>
        <hr/>
        <div class="offset-2 col-8 mt-4 dynamic-questions-section">
          <h5>Dynamic Reporting Questions</h5>
          <form method="post" action="{% url 'rolodex:project_data_responses' project.id %}" class="project-data-responses-form">
            {% csrf_token %}
            {% regroup data_questions by section as question_sections %}
            {% for section in question_sections %}
              <div class="card mb-4 dynamic-question-card">
                <div class="card-header text-uppercase text-muted">{{ section.grouper }}</div>
                <div class="card-body">
                  {% regroup section.list by subheading as subgroup_list %}
                  {% for subgroup in subgroup_list %}
                    {% if subgroup.grouper %}
                      <h6 class="font-weight-bold{% if not forloop.first %} mt-3{% endif %}">{{ subgroup.grouper }}</h6>
                    {% endif %}
                    <div class="dynamic-questions-grid">
                      {% for question in subgroup.list %}
                        {% with field=data_responses_fields|get_item:question.key %}
                          {% if field %}
                            <div class="form-group dynamic-question-item{% if question.key == 'wireless_psk_masterpass_ssids' or question.key == 'assessment_scope_cloud_on_prem' or question.key == 'general_scope_changed' or question.key == 'hashes_obtained' %} d-none{% endif %}" data-question="{{ question.key }}"{% if question.key == 'wireless_segmentation_ssids' %} data-segmentation-target{% endif %}{% if question.key == 'wireless_psk_masterpass_ssids' %} data-masterpass-target{% endif %}{% if question.key == 'assessment_scope' %} data-scope-control{% endif %}{% if question.key == 'assessment_scope_cloud_on_prem' %} data-scope-cloud-followup{% endif %}{% if question.key == 'general_first_ca' %} data-first-ca-control{% endif %}{% if question.key == 'general_scope_changed' %} data-first-ca-followup{% endif %}{% if question.key == 'hashes_obtained' %} data-password-followup{% endif %}>
                              {% if field.label %}{{ field.label_tag }}{% endif %}
                              {{ field }}
                              {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                            </div>
                          {% endif %}
                        {% endwith %}
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
            <div class="text-right">
              <button type="submit" class="btn btn-primary">Save Responses</button>
            </div>
          </form>
        </div>
      </div>

      <div id="processed-data" class="tab-pane">
        <h4>Processed Data</h4>
        <hr/>
        {% if processed_data_cards %}
          <div class="row">
            {% for card in processed_data_cards %}
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title">{{ card.label }}</h5>
                    <dl class="row small mb-3">
                      <dt class="col-6">Total Count</dt>
                      {% with total_count=card.summary.total|default:card.summary.unique %}
                        <dd class="col-6 text-right">{{ total_count|default:0 }}</dd>
                      {% endwith %}
                      <dt class="col-6">Total Highs</dt>
                      {% with total_high=card.summary.total_high|default:card.summary.unique_high %}
                        <dd class="col-6 text-right">{{ total_high|default:0 }}</dd>
                      {% endwith %}
                      <dt class="col-6">Total Mediums</dt>
                      {% with total_med=card.summary.total_med|default:card.summary.unique_med %}
                        <dd class="col-6 text-right">{{ total_med|default:0 }}</dd>
                      {% endwith %}
                      <dt class="col-6">Total Lows</dt>
                      {% with total_low=card.summary.total_low|default:card.summary.unique_low %}
                        <dd class="col-6 text-right">{{ total_low|default:0 }}</dd>
                      {% endwith %}
                      {% if card.type == "web" %}
                        <dt class="col-6">Unique Highs</dt>
                        <dd class="col-6 text-right">{{ card.summary.unique_high|default:0 }}</dd>
                        <dt class="col-6">Unique Mediums</dt>
                        <dd class="col-6 text-right">{{ card.summary.unique_med|default:0 }}</dd>
                        <dt class="col-6">Unique Lows</dt>
                        <dd class="col-6 text-right">{{ card.summary.unique_low|default:0 }}</dd>
                        {% if card.summary.host_risk_counts %}
                          <dt class="col-12 mt-2">Host Risk Counts</dt>
                          <dd class="col-12">
                            <ul class="list-unstyled small mb-0">
                              {% for host in card.summary.host_risk_counts %}
                                <li class="mb-1">
                                  <span class="font-weight-bold">{{ host.host }}</span>:
                                  High {{ host.high|default:0 }},
                                  Med {{ host.medium|default:0 }},
                                  Low {{ host.low|default:0 }}
                                </li>
                              {% endfor %}
                            </ul>
                          </dd>
                        {% endif %}
                      {% elif card.type == "firewall" %}
                        <dt class="col-6">Rule Count</dt>
                        <dd class="col-6 text-right">{{ card.summary.rule_count|default:0 }}</dd>
                        <dt class="col-6">Config Count</dt>
                        <dd class="col-6 text-right">{{ card.summary.config_count|default:0 }}</dd>
                        <dt class="col-6">Complexity Count</dt>
                        <dd class="col-6 text-right">{{ card.summary.complexity_count|default:0 }}</dd>
                        <dt class="col-6">Vulnerability Count</dt>
                        <dd class="col-6 text-right">{{ card.summary.vuln_count|default:0 }}</dd>
                      {% else %}
                        <dt class="col-6">Unique High/Medium</dt>
                        <dd class="col-6 text-right">{{ card.summary.unique_high_med|default:0 }}</dd>
                        <dt class="col-6">OOD Count</dt>
                        <dd class="col-6 text-right">{{ card.summary.total_ood|default:0 }}</dd>
                        <dt class="col-6">ISC Count</dt>
                        <dd class="col-6 text-right">{{ card.summary.total_isc|default:0 }}</dd>
                        <dt class="col-6">IWC Count</dt>
                        <dd class="col-6 text-right">{{ card.summary.total_iwc|default:0 }}</dd>
                      {% endif %}
                    </dl>
                    {% if card.type == "firewall" and card.devices %}
                      <div class="small mb-3">
                        <h6 class="font-weight-bold">Devices</h6>
                        <ul class="list-unstyled mb-0">
                          {% for device in card.devices %}
                            <li class="mb-1">
                              <span class="font-weight-bold">{{ device.device }}</span>:
                              High {{ device.total_high|default:0 }}, Med {{ device.total_med|default:0 }}, Low {{ device.total_low|default:0 }}, OOD {{ device.ood|default:"no" }}
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                    {% if card.has_file %}
                      {% if card.type == "web" %}
                        <a class="btn btn-outline-primary btn-sm" href="{% url 'rolodex:project_web_data_download' project.id %}">
                          Download Web Data file
                        </a>
                      {% elif card.type == "firewall" %}
                        <a class="btn btn-outline-primary btn-sm" href="{% url 'rolodex:project_firewall_data_download' project.id %}">
                          Download Firewall Data file
                        </a>
                      {% else %}
                        <a class="btn btn-outline-primary btn-sm" href="{% url 'rolodex:project_nexpose_data_download' project.id %}?artifact={{ card.metrics_key }}">
                          Download Nexpose Data file
                        </a>
                      {% endif %}
                    {% else %}
                      <p class="text-muted small mb-0">The data file will be available after processing completes.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="card mb-3">
            <div class="card-body">
              <form method="post" action="{% url 'rolodex:project_nexpose_distilled_update' project.id %}" class="mb-0">
                {% csrf_token %}
                <div class="custom-control custom-switch">
                  <input
                    type="checkbox"
                    class="custom-control-input"
                    id="id_nexpose_distilled"
                    name="nexpose_distilled"
                    value="1"
                    {% if nexpose_distilled %}checked{% endif %}
                  >
                  <label class="custom-control-label" for="id_nexpose_distilled">
                    Distill Nexpose CAP issues to remediation actions
                  </label>
                </div>
                <p class="text-muted small mt-2 mb-3">
                  When enabled, CAP exports replace the vulnerability title with the remediation action text.
                </p>
                <button type="submit" class="btn btn-primary btn-sm">Save Preference</button>
              </form>
            </div>
          </div>
        {% else %}
          <p class="text-muted offset-2 col-8">No Nexpose XML uploads have been processed yet.</p>
        {% endif %}
      </div>

      <div id="documents" class="tab-pane">
        <h4>Generate Project Documents</h4>
        <hr/>

        <p class="text-justify offset-2 col-8">
          Generate JSON with project data or select a template to generate a project document (e.g., SOW, ROE).
        </p>
        <p class="text-justify offset-2 col-8">
          No report data is available to these templates, so only the Word templates that are marked as project templates will be available.
        </p>

        <div class="input-group mb-3 offset-2 col-8">
          <div class="input-group-prepend">
            <span class="input-group-text" id="projectExportFilename">Options</span>
          </div>
          <select class="form-control form-select custom-select" id="projectExportSelector"
                  data-url="{% url 'rolodex:ajax_project_generate_report' project.pk 'replaceme' %}">
            <option value="json">JSON</option>
            {% for template in export_templates %}
              <option value="{{ template.pk }}">{{ template.name }} ({{ template.doc_type.extension }})</option>
            {% endfor %}
          </select>
          <span class="input-group-append">
            <button id="projectExportButton" class="btn btn-outline-primary">Generate</button>
          </span>
        </div>

        <h4>Project Reports & Findings</h4>
        <hr/>

        {% if project.complete %}
          <p>The project is marked as complete so no additional reports may be created.</p>
        {% else %}
          <a class="icon add-icon btn btn-primary mb-3 col-3" href="{% url 'reporting:report_create' project.id %}">Add a Report</a>
        {% endif %}

        <p>View and edit findings by opening the related report (click the link).</p>

        {% if project.report_set.all %}
          <table id="reportTable" class="tablesorter table">
            <thead>
            <th class="align-middle pr-4 text-left">Title</th>
            <th class="align-middle pr-4 text-left">Status</th>
            <th class="align-middle pr-4 text-left">Last Update</th>
            <th class="align-middle pr-4 text-left">Created By</th>
            <th class="sorter-false text-center align-middle">Options</th>
            </thead>
            {% for report in project.report_set.all %}
              <tr>
                <td class="align-middle text-left"><a class="clickable" href="{{ report.get_absolute_url }}">{{ report.title }}</a></td>
                {% if report.complete %}
                  {% if report.delivered %}
                    <td class="align-middle text-left">Delivered</td>
                  {% else %}
                    <td class="align-middle text-left">Complete, Awaiting Delivery</td>
                  {% endif %}
                {% else %}
                  <td class="align-middle text-left">In Progress</td>
                {% endif %}
                <td class="align-middle text-left">{{ report.last_update|date:"DATE_FORMAT" }}</td>
                <td class="align-middle text-left">{{ report.created_by }}</td>
                <td class="align-middle">
                  <div class="d-flex justify-content-center">
                    <a title="Set this report as your active report" href="javascript:void(0)"
                       class="clickable-link js-activate-report icon power-icon"
                       activate-report-csrftoken="{{ csrf_token }}"
                       activate-report-url="{% url 'reporting:ajax_activate_report' report.id %}"
                       activate-report-id="{{ report.id }}"></a>
                    <a class="icon clone-icon" title="Make a copy of this report on this project"
                       href="{% url 'reporting:report_clone' report.id %}"></a>
                    <a class="icon archive-icon" title="Archive this report"
                       href="{% url 'reporting:archive' report.id %}"></a>
                    <a class="icon trash-icon" title="Delete this report"
                       href="{% url 'reporting:report_delete' report.id %}"></a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </table>

          {% for report in project.report_set.all %}
            {% if report.reportfindinglink_set.all %}
              <div class="offset-2 col-8 mt-4">
                <h5>{{ report.title }} Findings</h5>
                <ul class="list-group">
                  {% for link in report.reportfindinglink_set.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      {{ link.finding.title }}
                      <span class="badge badge-primary badge-pill">{{ link.severity }}</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="alert alert-warning offset-2 col-8 mt-3" role="alert">There are no reports for this project yet.</div>
        {% endif %}
      </div>

      {% if project_extra_fields_spec %}
        <div id="extra_fields" class="tab-pane">
          <h4>Extra Fields</h4>
          <hr/>
          {% include "user_extra_fields/field_preview_display.html" with object=project object_extra_fields_spec=project_extra_fields_spec %}
        </div>
      {% endif %}

      <div id="notes" class="tab-pane">
        <h4>Project Notes</h4>
        <hr/>

        <a class="icon add-icon btn btn-primary mb-3 col-3" href="{% url 'rolodex:project_note_add' project.id %}">Add a Note</a>

        {% if project.projectnote_set.all %}
          {% for note in project.projectnote_set.all reversed %}
            <div id="note-container-{{ note.id }}">
              <div class="container note-container {% if forloop.counter|divisibleby:2 %}darker{% endif %}">
                <div class="float-left col-10 col-md-10 col-sm-8">
                  {{ note.note|bleach }}
                </div>
                <div class="float-right col-2 col-md-2 col-sm-4">
                  <div>{% if note.operator %}<a class="note-link"
                                                href="{% url 'users:user_detail' note.operator.username %}">{{ note.operator.username }}</a>{% else %}
                    <span class="note-link">Deleted</span>{% endif %}</div>
                  <div><p class="note-time">{{ note.timestamp }}</p></div>
                </div>
              </div>
            </div>

            {% if request.user == note.operator or request.user|is_privileged %}
              <div class="pb-3">
                <a class="note-link" href="{% url 'rolodex:project_note_edit' note.id %}">Edit</a> |
                <a id="note-delete-button-{{ note.id }}" class="js-confirm-delete note-link" data-toggle="modal"
                   data-target="#confirm-delete-modal" href="javascript:void(0);"
                   delete-target-csrftoken="{{ csrf_token }}"
                   delete-target-url="{% url 'rolodex:ajax_delete_project_note' note.id %}"
                   delete-target-id="{{ note.id }}" delete-target-type="note">Delete</a>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="alert alert-warning offset-md-2 col-md-8 mt-1" role="alert">There are no notes for this project.</div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block morescripts %}
  {{ block.super }}
  {% get_solo "commandcenter.ReportConfiguration" as report_config %}
  <script>
    const PROJECT_SCROLL_STORAGE_PREFIX = 'project-detail-scroll:';

    function getProjectScrollStorageKey() {
      const path = window.location.pathname || '';
      const hash = window.location.hash || '';
      return PROJECT_SCROLL_STORAGE_PREFIX + path + hash;
    }

    function storeProjectScrollPosition() {
      try {
        const key = getProjectScrollStorageKey();
        const position = typeof window.scrollY === 'number' ? window.scrollY : window.pageYOffset;
        sessionStorage.setItem(key, String(position || 0));
      } catch (error) {
        // sessionStorage may be unavailable (e.g., private browsing modes)
      }
    }

    function restoreProjectScrollPosition() {
      try {
        const key = getProjectScrollStorageKey();
        const stored = sessionStorage.getItem(key);
        if (stored !== null) {
          const position = parseFloat(stored);
          sessionStorage.removeItem(key);
          if (!Number.isNaN(position)) {
            window.requestAnimationFrame(function() {
              window.scrollTo(0, position);
            });
          }
        }
      } catch (error) {
        // sessionStorage may be unavailable (e.g., private browsing modes)
      }
    }

    (function($) {
      $(function() {
        const projectExportSelector = $("#projectExportSelector");
        const projectExportButton = $("#projectExportButton");
        projectExportButton.on("click", function() {
          const url = projectExportSelector.attr("data-url").replace("replaceme", projectExportSelector.val());
          const a = document.createElement("a");
          a.href = url;
          a.click();
        });

        const $projectDescription = $('#projectDescription');
        const $projectDescDropdown = $('#projectDescriptionDropdown');
        $projectDescription.hide();
        $projectDescDropdown.on('click', function() {
          $projectDescription.slideToggle('slow');
          $projectDescDropdown.toggleClass('add-icon sub-icon');
        });

        $('#reportTable').tablesorter({
          cssAsc: 'down',
          cssDesc: 'up',
          cssNone: 'none'
        });
        $('.tablesorter').trigger('update');

        const workbookForm = document.getElementById('project-workbook-form');
        const workbookInput = document.getElementById('id_workbook_file');
        if (workbookForm && workbookInput) {
          const uploadButton = workbookForm.querySelector('button[type="submit"]');

          const setUploadingState = function() {
            if (!workbookForm || workbookForm.dataset.submitting === '1') {
              return;
            }
            workbookForm.dataset.submitting = '1';
            workbookForm.classList.add('is-uploading');
            if (uploadButton) {
              const defaultText = uploadButton.getAttribute('data-default-text') || uploadButton.textContent.trim();
              uploadButton.setAttribute('data-default-text', defaultText);
              uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>Uploading...';
              uploadButton.disabled = true;
            }
          };

          workbookForm.addEventListener('submit', function() {
            setUploadingState();
          });

          workbookInput.addEventListener('change', function() {
            if (workbookInput.files && workbookInput.files.length) {
              setUploadingState();
              if (typeof workbookForm.requestSubmit === 'function') {
                workbookForm.requestSubmit();
              } else {
                workbookForm.submit();
              }
            }
          });
        }

        const dataForms = document.querySelectorAll('.project-required-data-form');
        dataForms.forEach(function(form) {
          const fileInput = form.querySelector('.project-required-data-input');
          const submitButton = form.querySelector('button[type="submit"]');
          if (!fileInput) {
            return;
          }

          const setUploadingState = function() {
            if (form.dataset.submitting === '1') {
              return;
            }
            form.dataset.submitting = '1';
            if (submitButton) {
              const defaultText = submitButton.getAttribute('data-default-text') || submitButton.textContent.trim();
              submitButton.setAttribute('data-default-text', defaultText);
              submitButton.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>Uploading...';
              submitButton.disabled = true;
            }
          };

          form.addEventListener('submit', function() {
            storeProjectScrollPosition();
            setUploadingState();
          });

          fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files.length) {
              storeProjectScrollPosition();
              setUploadingState();
              if (typeof form.requestSubmit === 'function') {
                form.requestSubmit();
              } else {
                form.submit();
              }
            }
          });
        });

        const ipForms = document.querySelectorAll('.project-ip-artifact-form');
        ipForms.forEach(function(form) {
          const submitButton = form.querySelector('button[type="submit"]');
          if (!submitButton) {
            return;
          }

          form.addEventListener('submit', function() {
            if (form.dataset.submitting === '1') {
              return;
            }
            storeProjectScrollPosition();
            form.dataset.submitting = '1';
            const defaultText = submitButton.getAttribute('data-default-text') || submitButton.textContent.trim();
            submitButton.setAttribute('data-default-text', defaultText);
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>Saving...';
            submitButton.disabled = true;
          });
        });

        const questionnaireForms = document.querySelectorAll('.project-data-responses-form');
        questionnaireForms.forEach(function(form) {
          form.addEventListener('submit', function() {
            storeProjectScrollPosition();
          });
        });

        const workbookTab = document.getElementById('workbook');
        const workbookUpdateUrl = workbookTab ? workbookTab.getAttribute('data-workbook-update-url') : null;
        const parseJsonScript = function(id) {
          const node = document.getElementById(id);
          if (!node) {
            return null;
          }
          try {
            return JSON.parse(node.textContent);
          } catch (error) {
            return null;
          }
        };

        const workbookState = parseJsonScript('project-workbook-data') || {};
        const dataArtifactsState = parseJsonScript('project-data-artifacts') || {};
        const scopingState = parseJsonScript('project-scoping-data') || {};
        const scopingWeights = parseJsonScript('project-scoping-weights') || {};
        const scopingConfig = parseJsonScript('project-scoping-config') || {};
        const riskScoreMap = parseJsonScript('project-risk-score-map') || {};
        const riskLabels = Object.keys(riskScoreMap);

        const setCardProgress = function(cardKey, filled, total) {
          const bar = document.getElementById('workbook-progress-' + cardKey);
          if (!bar) {
            return;
          }
          const percent = total ? Math.round((filled / total) * 100) : 0;
          bar.style.width = percent + '%';
          bar.setAttribute('aria-valuenow', percent);
          bar.textContent = percent + '%';
        };

        const updateWorkbookCardProgress = function(cardKey) {
          const shouldUpdate = function(target) {
            return !cardKey || cardKey === target;
          };
          if (shouldUpdate('general')) {
            const generalInputs = document.querySelectorAll('#workbook-general-fields input');
            let filled = 0;
            generalInputs.forEach(function(input) {
              if ((input.value || '').trim()) {
                filled += 1;
              }
            });
            setCardProgress('general', filled, generalInputs.length);
          }
          if (shouldUpdate('scoring')) {
            const scoreInputs = document.querySelectorAll('.workbook-score-input');
            let filled = 0;
            scoreInputs.forEach(function(input) {
              if (!Number.isNaN(parseFloat(input.value))) {
                filled += 1;
              }
            });
            setCardProgress('scoring', filled, scoreInputs.length);
          }
          if (shouldUpdate('grades')) {
            const gradeInputs = document.querySelectorAll('.workbook-grade-select');
            let filled = 0;
            gradeInputs.forEach(function(select) {
              if ((select.value || '').trim()) {
                filled += 1;
              }
            });
            setCardProgress('grades', filled, gradeInputs.length);
          }
          const areaCards = document.querySelectorAll('.workbook-area-card');
          areaCards.forEach(function(card) {
            const areaKey = card.getAttribute('data-area-key');
            if (!areaKey || (cardKey && cardKey !== areaKey)) {
              return;
            }
            const inputs = document.querySelectorAll('[data-area-field="' + areaKey + '"]');
            let filled = 0;
            inputs.forEach(function(input) {
              if ((input.value || '').toString().trim()) {
                filled += 1;
              }
            });
            setCardProgress(areaKey, filled, inputs.length);
          });
        };

        const formatDateForInput = function(value) {
          if (!value) {
            return '';
          }
          const parsed = new Date(value);
          if (Number.isNaN(parsed.getTime())) {
            return value;
          }
          return parsed.toISOString().slice(0, 10);
        };

        const titleize = function(value) {
          return (value || '')
            .toString()
            .replace(/[_-]+/g, ' ')
            .replace(/\w\S*/g, function(txt) {
              return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        };

        const scopeSelected = function(scopeKey) {
          const scope = scopingState[scopeKey];
          return scope && scope.selected;
        };

        const areaSubsectionConfig = {
          osint: {
            label: 'OSINT',
            fields: [
              {key: 'total_domains', label: 'Total domains found', type: 'number'},
              {key: 'total_hostnames', label: 'Total hostnames/subdomains found', type: 'number'},
              {key: 'total_ips', label: 'Total IPs found', type: 'number'},
              {key: 'total_cloud', label: 'Total Cloud Providers found', type: 'number'},
              {key: 'total_buckets', label: 'Total Open Buckets found', type: 'number'},
              {key: 'total_squat', label: 'Total Domain Squatters found', type: 'number'},
              {key: 'total_leaks', label: 'Total Leaked Creds found', type: 'number'},
            ],
          },
          dns: {
            label: 'DNS',
          },
        };

        const createAreaFieldGroup = function(areaKey, subkey, field) {
          const inlineLayout = field.layout !== 'stacked' && field.type !== 'text';
          const formGroup = document.createElement('div');
          formGroup.className = inlineLayout
            ? 'form-group row align-items-center mb-2'
            : 'form-group';
          const label = document.createElement('label');
          label.className = inlineLayout
            ? 'col-12 col-sm-6 col-md-5 col-lg-6 col-form-label font-weight-bold pr-sm-2'
            : 'font-weight-bold';
          label.setAttribute('for', 'area-' + subkey + '-' + field.key);
          label.textContent = field.label;
          const input = document.createElement('input');
          input.type = field.type || 'text';
          input.className = 'form-control';
          input.id = 'area-' + subkey + '-' + field.key;
          input.setAttribute('data-area-field', areaKey);
          const existing = workbookState[subkey] && workbookState[subkey][field.key];
          input.value = typeof existing === 'number' ? existing : (existing || '');
          input.addEventListener('input', function() {
            updateWorkbookCardProgress(areaKey);
          });
          if (inlineLayout) {
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'col-12 col-sm-6 col-md-7 col-lg-6';
            inputWrapper.appendChild(input);
            formGroup.appendChild(label);
            formGroup.appendChild(inputWrapper);
          } else {
            formGroup.appendChild(label);
            formGroup.appendChild(input);
          }
          return formGroup;
        };

        const scoreToRisk = function(score) {
          if (score === null || typeof score === 'undefined') {
            return null;
          }
          const numericScore = parseFloat(score);
          if (Number.isNaN(numericScore)) {
            return null;
          }
          let detected = null;
          Object.keys(riskScoreMap).forEach(function(risk) {
            const bounds = riskScoreMap[risk] || {};
            const min = typeof bounds.min === 'number' ? bounds.min : parseFloat(bounds.min);
            const max = typeof bounds.max === 'number' ? bounds.max : parseFloat(bounds.max);
            if (Number.isNaN(min) || Number.isNaN(max) || detected) {
              return;
            }
            if (numericScore >= min && numericScore <= max) {
              detected = risk;
            }
          });
          return detected;
        };

        const buildRiskLegend = function() {
          const legendContainer = document.getElementById('risk-score-legend');
          if (!legendContainer) {
            return;
          }
          const fragments = document.createDocumentFragment();
          const legendCard = document.createElement('div');
          legendCard.className = 'card h-100';
          const legendHeader = document.createElement('div');
          legendHeader.className = 'card-header font-weight-bold';
          legendHeader.textContent = 'Risk to Score Mapping';
          const legendBody = document.createElement('div');
          legendBody.className = 'card-body p-3';
          const list = document.createElement('ul');
          list.className = 'list-unstyled mb-0';
          Object.keys(riskScoreMap).forEach(function(risk) {
            const bounds = riskScoreMap[risk];
            if (!bounds) {
              return;
            }
            const item = document.createElement('li');
            item.textContent = risk + ': ' + bounds.min + ' - ' + bounds.max;
            list.appendChild(item);
          });
          legendBody.appendChild(list);
          legendCard.appendChild(legendHeader);
          legendCard.appendChild(legendBody);
          fragments.appendChild(legendCard);
          legendContainer.innerHTML = '';
          legendContainer.appendChild(fragments);
        };

        const workbookGeneralFieldConfig = [
          {key: 'external_start', label: 'External Start Date', scope: 'external', type: 'date'},
          {key: 'external_end', label: 'External End Date', scope: 'external', type: 'date'},
          {key: 'internal_start', label: 'Internal Start Date', scope: 'internal', type: 'date'},
          {key: 'internal_end', label: 'Internal End Date', scope: 'internal', type: 'date'},
          {key: 'cloud_start', label: 'Cloud Start Date', scope: 'cloud', type: 'date'},
          {key: 'cloud_end', label: 'Cloud End Date', scope: 'cloud', type: 'date'},
          {key: 'wireless', label: 'Wireless Date', scope: 'wireless', type: 'date'},
          {key: 'firewall', label: 'Firewall Date', scope: 'firewall', type: 'date'},
          {key: 'internal_subnets', label: 'Internal Subnets', scope: 'internal', type: 'text'},
          {key: 'cloud_provider', label: 'Cloud Provider', scope: 'cloud', type: 'text'},
        ];

        const renderGeneralFields = function() {
          const container = document.getElementById('workbook-general-fields');
          if (!container) {
            return;
          }
          container.innerHTML = '';
          const fragment = document.createDocumentFragment();
          workbookGeneralFieldConfig.forEach(function(field) {
            if (!scopeSelected(field.scope)) {
              return;
            }
            const col = document.createElement('div');
            col.className = 'col-md-6 form-group';
            const label = document.createElement('label');
            label.className = 'font-weight-bold';
            label.setAttribute('for', 'workbook-general-' + field.key);
            label.textContent = field.label;
            const input = document.createElement('input');
            input.type = field.type;
            input.className = 'form-control';
            input.id = 'workbook-general-' + field.key;
            const existing = workbookState.general && workbookState.general[field.key];
            input.value = existing ? formatDateForInput(existing) : '';
            input.addEventListener('input', function() {
              updateWorkbookCardProgress('general');
            });
            col.appendChild(label);
            col.appendChild(input);
            fragment.appendChild(col);
          });
          container.appendChild(fragment);
          updateWorkbookCardProgress('general');
        };

        const scoreValueAliases = {
          iam: {
            ad: {category: 'internal', option: 'iam'},
            password: {category: 'internal', option: 'password'},
          },
        };

        const getExistingScoreValue = function(categoryKey, optionKey) {
          const direct = workbookState.external_internal_grades
            && workbookState.external_internal_grades[categoryKey]
            && workbookState.external_internal_grades[categoryKey][optionKey]
            ? workbookState.external_internal_grades[categoryKey][optionKey].score
            : null;
          if (typeof direct === 'number') {
            return direct;
          }
          const aliasCategory = scoreValueAliases[categoryKey] && scoreValueAliases[categoryKey][optionKey];
          if (aliasCategory) {
            const {category, option} = aliasCategory;
            if (workbookState.external_internal_grades
              && workbookState.external_internal_grades[category]
              && workbookState.external_internal_grades[category][option]) {
              return workbookState.external_internal_grades[category][option].score;
            }
          }
          return null;
        };

        const getScoresFromInputs = function() {
          const scoreInputs = document.querySelectorAll('.workbook-score-input');
          const scores = {};
          scoreInputs.forEach(function(input) {
            const category = input.getAttribute('data-category');
            const option = input.getAttribute('data-option');
            if (!category || !option) {
              return;
            }
            const value = parseFloat(input.value);
            const sanitized = Number.isNaN(value) ? null : Math.min(Math.max(value, 0), 6);
            if (!scores[category]) {
              scores[category] = {};
            }
            scores[category][option] = sanitized;
          });
          return scores;
        };

        const updateTotalsAndGrades = function() {
          const scoreGroups = document.querySelectorAll('.workbook-score-group');
          const computedGrades = {};
          scoreGroups.forEach(function(group) {
            const category = group.getAttribute('data-category');
            const totalDisplay = group.querySelector('.workbook-score-total');
            const gradeDisplay = group.querySelector('.workbook-score-grade');
            const inputs = group.querySelectorAll('.workbook-score-input');
            const weightLookup = scopingWeights[category] || {};
            const hasWeights = Object.keys(weightLookup).length > 0;
            let total = 0;
            let weightTotal = 0;
            let populated = false;
            inputs.forEach(function(input) {
              const option = input.getAttribute('data-option');
              const raw = parseFloat(input.value);
              const value = Number.isNaN(raw) ? 0 : Math.min(Math.max(raw, 0), 6);
              const weight = weightLookup[option];
              if (hasWeights && typeof weight === 'number') {
                total += value * weight;
                weightTotal += weight;
              } else if (!hasWeights) {
                total += value;
                weightTotal += 1;
              }
              if (!Number.isNaN(raw)) {
                populated = true;
              }
            });
            if (!populated) {
              if (totalDisplay) { totalDisplay.textContent = 'â€”'; }
              if (gradeDisplay) { gradeDisplay.textContent = 'â€”'; }
              computedGrades[category] = null;
              return;
            }
            const divisor = weightTotal || inputs.length || 1;
            const normalizedTotal = total / divisor;
            const roundedTotal = Math.round(normalizedTotal * 10) / 10;
            const riskLabel = scoreToRisk(roundedTotal);
            if (totalDisplay) {
              totalDisplay.textContent = roundedTotal.toFixed(1);
            }
            if (gradeDisplay) {
              gradeDisplay.textContent = riskLabel || 'â€”';
            }
            computedGrades[category] = {total: roundedTotal, grade: riskLabel};
            if (!workbookState.external_internal_grades) {
              workbookState.external_internal_grades = {};
            }
            const categoryState = workbookState.external_internal_grades[category] || {};
            categoryState.total = roundedTotal;
            categoryState.grade = riskLabel;
            workbookState.external_internal_grades[category] = categoryState;
          });
          updateWorkbookCardProgress('grades');
          updateWorkbookCardProgress('scoring');
          return computedGrades;
        };

        const optionIsSelected = function(categoryKey, optionKey) {
          const scope = scopingState[categoryKey];
          if (!scope) {
            return false;
          }
          if (optionKey === 'selected') {
            return scope.selected;
          }
          return Boolean(scope[optionKey]);
        };

        const getAreaSubkeys = function(areaKey) {
          const scope = scopingState[areaKey] || {};
          return Object.keys(scope).filter(function(optionKey) {
            return optionKey !== 'selected' && optionIsSelected(areaKey, optionKey);
          });
        };

        const saveAreaData = function(areaKey, subkeys, modalId) {
          if (!Array.isArray(subkeys) || !subkeys.length) {
            return;
          }
          const payload = {areas: {}};
          subkeys.forEach(function(subkey) {
            if (subkey === 'dns') {
              payload.areas[subkey] = collectDnsPayload();
              return;
            }
            const config = areaSubsectionConfig[subkey];
            if (!config || !config.fields) {
              return;
            }
            const fieldPayload = {};
            config.fields.forEach(function(field) {
              const input = document.getElementById('area-' + subkey + '-' + field.key);
              if (!input) {
                return;
              }
              const rawValue = (input.value || '').trim();
              if (field.type === 'number') {
                fieldPayload[field.key] = rawValue === '' ? null : Number(rawValue);
              } else {
                fieldPayload[field.key] = rawValue || null;
              }
            });
            payload.areas[subkey] = fieldPayload;
          });
          submitWorkbookUpdate(payload, function() {
            if (modalId) {
              $('#' + modalId).modal('hide');
            }
          });
        };

        const cleanupModalBackdrops = function() {
          const activeModals = document.querySelectorAll('.modal.show');
          if (activeModals.length) {
            return;
          }
          document.body.classList.remove('modal-open');
          document.body.style.paddingRight = '';
          document.querySelectorAll('.modal-backdrop').forEach(function(backdrop) {
            if (backdrop && backdrop.parentNode) {
              backdrop.parentNode.removeChild(backdrop);
            }
          });
        };

        const refreshWorkbookFromResponse = function(data, areaKey, modalId) {
          const modalSelector = modalId ? '#' + modalId : null;
          const modalWasOpen = modalSelector ? $(modalSelector).hasClass('show') : false;

          if (data && data.workbook_data) {
            Object.assign(workbookState, data.workbook_data);
          }
          if (data && data.data_artifacts) {
            Object.assign(dataArtifactsState, data.data_artifacts);
          }
          renderGeneralFields();
          renderScoringGroups();
          renderGradeFields();
          renderAreaCards();
          updateWorkbookCardProgress(areaKey);
          if (modalSelector && modalWasOpen) {
            $(modalSelector).modal('show');
          }
          cleanupModalBackdrops();
        };

        const removeOsintData = function(areaKey, modalId) {
          submitWorkbookUpdate({remove_osint: true}, function() {
            if (modalId) {
              $('#' + modalId).modal('show');
            }
          });
        };

        const uploadOsintCsv = function(file, areaKey, modalId) {
          if (!workbookUpdateUrl || !file) {
            return;
          }
          const formData = new FormData();
          formData.append('osint_csv', file);
          fetch(workbookUpdateUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCsrfToken() || ''
            },
            body: formData,
          }).then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) {
                const message = (data && data.error) ? data.error : 'Unable to update workbook data';
                throw new Error(message);
              }
              return data;
            });
          }).then(function(data) {
            refreshWorkbookFromResponse(data, areaKey, modalId);
          }).catch(function(error) {
            console.error(error);
            alert(error.message || 'Unable to save workbook data.');
          });
        };

        const uploadDnsCsv = function(file, domain, areaKey, modalId) {
          const trimmedDomain = (domain || '').trim();
          if (!workbookUpdateUrl || !file) {
            return;
          }
          if (!trimmedDomain) {
            alert('Please provide a domain before uploading the DNS CSV.');
            return;
          }
          const formData = new FormData();
          formData.append('dns_csv', file);
          formData.append('dns_domain', trimmedDomain);
          fetch(workbookUpdateUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCsrfToken() || ''
            },
            body: formData,
          }).then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) {
                const message = (data && data.error) ? data.error : 'Unable to update workbook data';
                throw new Error(message);
              }
              return data;
            });
          }).then(function(data) {
            refreshWorkbookFromResponse(data, areaKey || 'dns', modalId);
          }).catch(function(error) {
            console.error(error);
            alert(error.message || 'Unable to save workbook data.');
          });
        };

        const uploadDnsXml = function(file, domain, areaKey, modalId) {
          const trimmedDomain = (domain || '').trim();
          if (!workbookUpdateUrl || !file) {
            return;
          }
          const formData = new FormData();
          formData.append('dns_xml', file);
          if (trimmedDomain) {
            formData.append('dns_domain', trimmedDomain);
          }
          fetch(workbookUpdateUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCsrfToken() || ''
            },
            body: formData,
          }).then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) {
                const message = (data && data.error) ? data.error : 'Unable to update workbook data';
                throw new Error(message);
              }
              return data;
            });
          }).then(function(data) {
            refreshWorkbookFromResponse(data, areaKey || 'dns', modalId);
          }).catch(function(error) {
            console.error(error);
            alert(error.message || 'Unable to save workbook data.');
          });
        };

        const collectDnsPayload = function() {
          const payload = {records: []};
          const container = document.getElementById('dns-domains-container');
          if (container) {
            const entries = container.querySelectorAll('.dns-domain-entry');
            entries.forEach(function(entry) {
              const domainInput = entry.querySelector('.dns-domain-input');
              const totalInput = entry.querySelector('.dns-total-input');
              const zoneSelect = entry.querySelector('.dns-zone-select');
              const record = {};
              const domainValue = (domainInput && domainInput.value) ? domainInput.value.trim() : '';
              const totalValue = (totalInput && totalInput.value) ? totalInput.value.trim() : '';
              const zoneValue = (zoneSelect && zoneSelect.value) ? zoneSelect.value : '';

              if (domainValue) {
                record.domain = domainValue;
              }
              if (totalValue !== '') {
                const parsed = Number(totalValue);
                record.total = Number.isNaN(parsed) ? null : parsed;
              }
              if (zoneValue) {
                record.zone_transfer = zoneValue;
              }

              if (Object.keys(record).length) {
                payload.records.push(record);
              }
            });
          }

          const uniqueInput = document.getElementById('dns-unique-total');
          if (uniqueInput) {
            const uniqueValue = uniqueInput.value.trim();
            if (uniqueValue === '') {
              payload.unique = null;
            } else {
              const parsed = Number(uniqueValue);
              payload.unique = Number.isNaN(parsed) ? null : parsed;
            }
          }

          return payload;
        };

        const removeDnsDomain = function(index, modalId) {
          const dnsPayload = collectDnsPayload();
          if (Array.isArray(dnsPayload.records)) {
            dnsPayload.records.splice(index, 1);
          }
          submitWorkbookUpdate({areas: {dns: dnsPayload}}, function() {
            if (modalId) {
              $('#' + modalId).modal('show');
            }
          });
        };

        const renderDnsDomain = function(container, record, index, modalId, areaKey) {
          const entry = document.createElement('div');
          entry.className = 'dns-domain-entry border rounded p-2 mb-3';
          const domainGroup = document.createElement('div');
          domainGroup.className = 'form-group';
          const domainLabel = document.createElement('label');
          domainLabel.className = 'font-weight-bold';
          domainLabel.textContent = 'Domain name';
          const domainInput = document.createElement('input');
          domainInput.type = 'text';
          domainInput.className = 'form-control dns-domain-input';
          domainInput.setAttribute('data-area-field', areaKey || 'dns');
          domainInput.value = (record && record.domain) ? record.domain : '';
          domainInput.addEventListener('input', function() {
            updateWorkbookCardProgress(areaKey);
          });
          domainGroup.appendChild(domainLabel);
          domainGroup.appendChild(domainInput);

          const totalGroup = document.createElement('div');
          totalGroup.className = 'form-group';
          const totalLabel = document.createElement('label');
          totalLabel.className = 'font-weight-bold';
          totalLabel.textContent = 'Total number of DNS findings';
          const totalInput = document.createElement('input');
          totalInput.type = 'number';
          totalInput.className = 'form-control dns-total-input';
          totalInput.setAttribute('data-area-field', areaKey || 'dns');
          totalInput.value = typeof (record && record.total) === 'number' ? record.total : '';
          totalInput.addEventListener('input', function() {
            updateWorkbookCardProgress(areaKey);
          });
          totalGroup.appendChild(totalLabel);
          totalGroup.appendChild(totalInput);

          const zoneGroup = document.createElement('div');
          zoneGroup.className = 'form-group';
          const zoneLabel = document.createElement('label');
          zoneLabel.className = 'font-weight-bold';
          zoneLabel.textContent = 'Was a zone transfer successful?';
          const zoneSelect = document.createElement('select');
          zoneSelect.className = 'form-control dns-zone-select';
          zoneSelect.setAttribute('data-area-field', areaKey || 'dns');
          const placeholderOption = document.createElement('option');
          placeholderOption.value = '';
          placeholderOption.textContent = 'Select an option';
          zoneSelect.appendChild(placeholderOption);
          ['Yes', 'No'].forEach(function(optionValue) {
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            if ((record && (record.zone_transfer || '')).toString().toLowerCase() === optionValue.toLowerCase()) {
              option.selected = true;
            }
            zoneSelect.appendChild(option);
          });
          zoneSelect.addEventListener('change', function() {
            updateWorkbookCardProgress(areaKey);
          });
          zoneGroup.appendChild(zoneLabel);
          zoneGroup.appendChild(zoneSelect);

          const actionsRow = document.createElement('div');
          actionsRow.className = 'd-flex flex-wrap align-items-center mt-2';

          const csvInput = document.createElement('input');
          csvInput.type = 'file';
          csvInput.accept = '.csv,text/csv';
          csvInput.className = 'd-none';
          csvInput.addEventListener('change', function(event) {
            const selectedFile = event.target.files && event.target.files[0];
            if (selectedFile) {
              uploadDnsCsv(selectedFile, domainInput.value, areaKey, modalId);
              event.target.value = '';
            }
          });

          const csvButton = document.createElement('button');
          csvButton.type = 'button';
          csvButton.className = 'btn btn-outline-primary mr-2 mb-2';
          csvButton.textContent = 'Upload DNS CSV';
          csvButton.addEventListener('click', function() {
            csvInput.click();
          });

          const xmlInput = document.createElement('input');
          xmlInput.type = 'file';
          xmlInput.accept = '.xml,application/xml,text/xml';
          xmlInput.className = 'd-none';
          xmlInput.addEventListener('change', function(event) {
            const selectedFile = event.target.files && event.target.files[0];
            if (selectedFile) {
              uploadDnsXml(selectedFile, domainInput.value, areaKey, modalId);
              event.target.value = '';
            }
          });

          const xmlButton = document.createElement('button');
          xmlButton.type = 'button';
          xmlButton.className = 'btn btn-outline-primary mr-2 mb-2';
          xmlButton.textContent = 'Upload DNS XML';
          xmlButton.addEventListener('click', function() {
            xmlInput.click();
          });

          const removeButton = document.createElement('button');
          removeButton.type = 'button';
          removeButton.className = 'btn btn-outline-danger mb-2';
          removeButton.textContent = 'Remove Domain';
          removeButton.addEventListener('click', function() {
            removeDnsDomain(index, modalId);
          });

          actionsRow.appendChild(csvInput);
          actionsRow.appendChild(csvButton);
          actionsRow.appendChild(xmlInput);
          actionsRow.appendChild(xmlButton);
          actionsRow.appendChild(removeButton);

          entry.appendChild(domainGroup);
          entry.appendChild(totalGroup);
          entry.appendChild(zoneGroup);
          entry.appendChild(actionsRow);
          container.appendChild(entry);
        };

        const renderDnsSection = function(container, modalId, areaKey) {
          const dnsData = (workbookState && workbookState.dns && typeof workbookState.dns === 'object') ? workbookState.dns : {};
          const records = Array.isArray(dnsData.records) ? dnsData.records : [];

          const addButton = document.createElement('button');
          addButton.type = 'button';
          addButton.className = 'btn btn-outline-primary mb-3';
          addButton.textContent = 'Add new Domain';
          addButton.addEventListener('click', function() {
            if (!workbookState.dns || typeof workbookState.dns !== 'object') {
              workbookState.dns = {records: []};
            }
            if (!Array.isArray(workbookState.dns.records)) {
              workbookState.dns.records = [];
            }
            workbookState.dns.records.push({domain: '', total: null, zone_transfer: null});
            renderAreaCards();
            if (modalId) {
              $('#' + modalId).modal('show');
            }
          });

          container.appendChild(addButton);

          const domainsWrapper = document.createElement('div');
          domainsWrapper.id = 'dns-domains-container';
          records.forEach(function(record, index) {
            renderDnsDomain(domainsWrapper, record || {}, index, modalId, areaKey);
          });

          container.appendChild(domainsWrapper);

          const uniqueGroup = document.createElement('div');
          uniqueGroup.className = 'form-group mt-3';
          const uniqueLabel = document.createElement('label');
          uniqueLabel.className = 'font-weight-bold';
          uniqueLabel.textContent = 'Unique total';
          const uniqueInput = document.createElement('input');
          uniqueInput.type = 'number';
          uniqueInput.className = 'form-control';
          uniqueInput.id = 'dns-unique-total';
          uniqueInput.setAttribute('data-area-field', areaKey || 'dns');
          uniqueInput.value = typeof dnsData.unique === 'number' ? dnsData.unique : '';
          uniqueInput.addEventListener('input', function() {
            updateWorkbookCardProgress(areaKey);
          });
          uniqueGroup.appendChild(uniqueLabel);
          uniqueGroup.appendChild(uniqueInput);
          container.appendChild(uniqueGroup);
        };

        const renderAreaCards = function() {
          const cardContainer = document.getElementById('workbook-area-cards');
          const modalContainer = document.getElementById('workbook-area-modals');
          if (!cardContainer || !modalContainer) {
            return;
          }
          cardContainer.innerHTML = '';
          modalContainer.innerHTML = '';
          const deck = document.createElement('div');
          deck.className = 'row workbook-area-grid';
          const modalFragment = document.createDocumentFragment();
          Object.keys(scopingState).forEach(function(areaKey) {
            if (!scopeSelected(areaKey)) {
              return;
            }
            const subkeys = getAreaSubkeys(areaKey);
            if (!subkeys.length) {
              return;
            }
            const modalId = 'workbook-area-modal-' + areaKey;
            const column = document.createElement('div');
            column.className = 'col-12 col-sm-6 col-lg-4 col-xl-3 d-flex workbook-area-col';
            const card = document.createElement('div');
            card.className = 'card workbook-entry-card mb-3 workbook-area-card flex-fill';
            card.setAttribute('role', 'button');
            card.setAttribute('data-toggle', 'modal');
            card.setAttribute('data-target', '#' + modalId);
            card.setAttribute('data-area-key', areaKey);
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body text-center';
            const cardTitle = document.createElement('h5');
            cardTitle.className = 'card-title mb-1';
            const areaConfig = scopingConfig[areaKey] || {};
            cardTitle.textContent = areaConfig.label || titleize(areaKey);
            const progress = document.createElement('div');
            progress.className = 'progress workbook-card-progress mt-2';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBar.id = 'workbook-progress-' + areaKey;
            progressBar.setAttribute('role', 'progressbar');
            progressBar.setAttribute('style', 'width: 0%');
            progressBar.setAttribute('aria-valuemin', '0');
            progressBar.setAttribute('aria-valuemax', '100');
            progress.appendChild(progressBar);
            cardBody.appendChild(cardTitle);
            cardBody.appendChild(progress);
            card.appendChild(cardBody);
            column.appendChild(card);
            deck.appendChild(column);

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = modalId;
            modal.tabIndex = -1;
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-labelledby', modalId + '-label');
            modal.setAttribute('aria-hidden', 'true');
            const modalDialog = document.createElement('div');
            modalDialog.className = 'modal-dialog modal-xl workbook-modal';
            modalDialog.setAttribute('role', 'document');
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';
            const modalTitle = document.createElement('h5');
            modalTitle.className = 'modal-title';
            modalTitle.id = modalId + '-label';
            modalTitle.textContent = (areaConfig.label || titleize(areaKey)) + ' Workbook Data';
            const modalClose = document.createElement('button');
            modalClose.type = 'button';
            modalClose.className = 'close';
            modalClose.setAttribute('data-dismiss', 'modal');
            modalClose.setAttribute('aria-label', 'Close');
            modalClose.innerHTML = '<span aria-hidden="true">&times;</span>';
            modalHeader.appendChild(modalTitle);
            modalHeader.appendChild(modalClose);
            const modalBody = document.createElement('div');
            modalBody.className = 'modal-body';
            const modalRow = document.createElement('div');
            modalRow.className = 'row workbook-area-modal-grid';
            subkeys.forEach(function(subkey) {
              const col = document.createElement('div');
              col.className = 'col-12 col-lg-6 col-xl-4 d-flex workbook-area-modal-col';
              const subCard = document.createElement('div');
              subCard.className = 'card mb-3 flex-fill';
              const subHeader = document.createElement('div');
              subHeader.className = 'card-header font-weight-bold';
              const subkeyLabel = (areaSubsectionConfig[subkey] && areaSubsectionConfig[subkey].label)
                ? areaSubsectionConfig[subkey].label
                : subkey.toUpperCase();
              subHeader.textContent = subkeyLabel;
              const subBody = document.createElement('div');
              subBody.className = 'card-body';
              const config = areaSubsectionConfig[subkey];
              if (subkey === 'dns') {
                renderDnsSection(subBody, modalId, areaKey);
              } else if (config && Array.isArray(config.fields)) {
                config.fields.forEach(function(field) {
                  const formGroup = createAreaFieldGroup(areaKey, subkey, field);
                  subBody.appendChild(formGroup);
                });
              } else {
                const empty = document.createElement('p');
                empty.className = 'mb-0';
                empty.textContent = 'No workbook fields are available for this area yet.';
                subBody.appendChild(empty);
              }
              if (subkey === 'osint') {
                const uploadWrapper = document.createElement('div');
                uploadWrapper.className = 'mt-2 d-flex flex-wrap align-items-center';
                const uploadInput = document.createElement('input');
                uploadInput.type = 'file';
                uploadInput.accept = '.csv,text/csv';
                uploadInput.className = 'd-none';
                uploadInput.id = 'area-' + subkey + '-upload';
                uploadInput.addEventListener('change', function(event) {
                  if (event.target.files && event.target.files[0]) {
                    uploadOsintCsv(event.target.files[0], areaKey, modalId);
                    event.target.value = '';
                  }
                });
                const uploadButton = document.createElement('button');
                uploadButton.type = 'button';
                uploadButton.className = 'btn btn-outline-primary mr-2 mb-2';
                uploadButton.textContent = 'Upload OSINT CSV';
                uploadButton.addEventListener('click', function() {
                  uploadInput.click();
                });
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'btn btn-outline-danger mb-2';
                removeButton.textContent = 'Remove OSINT Data';
                removeButton.addEventListener('click', function() {
                  removeOsintData(areaKey, modalId);
                });
                uploadWrapper.appendChild(uploadInput);
                uploadWrapper.appendChild(uploadButton);
                uploadWrapper.appendChild(removeButton);
                subBody.appendChild(uploadWrapper);
              }
              subCard.appendChild(subHeader);
              subCard.appendChild(subBody);
              col.appendChild(subCard);
              modalRow.appendChild(col);
            });
            modalBody.appendChild(modalRow);
            const modalFooter = document.createElement('div');
            modalFooter.className = 'modal-footer';
            const closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'btn btn-secondary';
            closeButton.setAttribute('data-dismiss', 'modal');
            closeButton.textContent = 'Close';
            const saveButton = document.createElement('button');
            saveButton.type = 'button';
            saveButton.className = 'btn btn-primary';
            saveButton.textContent = 'Save ' + (areaConfig.label || titleize(areaKey));
            saveButton.addEventListener('click', function() {
              saveAreaData(areaKey, subkeys, modalId);
            });
            modalFooter.appendChild(closeButton);
            modalFooter.appendChild(saveButton);
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalContent.appendChild(modalFooter);
            modalDialog.appendChild(modalContent);
            modal.appendChild(modalDialog);
            modalFragment.appendChild(modal);
          });
          if (deck.children.length) {
            cardContainer.appendChild(deck);
          }
          modalContainer.appendChild(modalFragment);
          updateWorkbookCardProgress();
        };

        const renderScoringGroups = function() {
          const container = document.getElementById('workbook-scoring-groups');
          if (!container) {
            return;
          }
          container.classList.add('row', 'workbook-scoring-grid');
          container.innerHTML = '';
          const fragment = document.createDocumentFragment();
          Object.keys(scopingState).forEach(function(categoryKey) {
            if (!scopeSelected(categoryKey)) {
              return;
            }
            const options = scopingConfig[categoryKey] && scopingConfig[categoryKey].options ? scopingConfig[categoryKey].options : {};
            const optionKeys = Object.keys(scopingState[categoryKey]).filter(function(optionKey) {
              return optionKey !== 'selected' && optionIsSelected(categoryKey, optionKey);
            });
            if (!optionKeys.length) {
              return;
            }
            const column = document.createElement('div');
            column.className = 'col-12 col-lg-6 col-xl-4 d-flex workbook-score-column';
            const card = document.createElement('div');
            card.className = 'card mb-2 workbook-score-group h-100 w-100';
            card.setAttribute('data-category', categoryKey);
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header font-weight-bold';
            const categoryConfig = scopingConfig[categoryKey] || {};
            cardHeader.textContent = categoryConfig.label || titleize(categoryKey);
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex flex-column workbook-score-body';
            optionKeys.forEach(function(optionKey) {
              const group = document.createElement('div');
              group.className = 'form-group row align-items-center mb-2 mx-0';
              const label = document.createElement('label');
              label.className = 'col-6 col-sm-6 col-md-6 col-lg-6 col-xl-6 col-form-label pr-1 pl-0 workbook-score-label';
              label.setAttribute('for', 'score-' + categoryKey + '-' + optionKey);
              label.textContent = titleize(options[optionKey] || optionKey);
              const input = document.createElement('input');
              input.type = 'number';
              input.className = 'form-control workbook-score-input';
              input.step = '0.1';
              input.min = '0';
              input.max = '6';
              input.id = 'score-' + categoryKey + '-' + optionKey;
              input.setAttribute('data-category', categoryKey);
              input.setAttribute('data-option', optionKey);
              const scoreValue = getExistingScoreValue(categoryKey, optionKey);
              input.value = typeof scoreValue === 'number' ? scoreValue : '';
              input.addEventListener('input', function() {
                updateTotalsAndGrades();
                updateWorkbookCardProgress('scoring');
              });
              group.appendChild(label);
              const inputWrapper = document.createElement('div');
              inputWrapper.className = 'col-6 col-sm-6 col-md-6 col-lg-6 col-xl-6 pl-0 workbook-score-input-wrapper';
              inputWrapper.appendChild(input);
              group.appendChild(inputWrapper);
              cardBody.appendChild(group);
            });

            const totalRow = document.createElement('div');
            totalRow.className = 'border-top pt-3 mt-3 text-center';
            const totalLabel = document.createElement('div');
            totalLabel.className = 'font-weight-bold';
            totalLabel.textContent = 'Total';
            const totalValue = document.createElement('div');
            totalValue.className = 'workbook-score-total';
            totalValue.textContent = 'â€”';
            const gradeLabel = document.createElement('div');
            gradeLabel.className = 'font-weight-bold mt-2';
            gradeLabel.textContent = 'Grade';
            const gradeValue = document.createElement('div');
            gradeValue.className = 'workbook-score-grade';
            gradeValue.textContent = 'â€”';
            totalRow.appendChild(totalLabel);
            totalRow.appendChild(totalValue);
            totalRow.appendChild(gradeLabel);
            totalRow.appendChild(gradeValue);
            cardBody.appendChild(totalRow);

            card.appendChild(cardHeader);
            card.appendChild(cardBody);
            column.appendChild(card);
            fragment.appendChild(column);
          });
          container.appendChild(fragment);
          updateTotalsAndGrades();
          updateWorkbookCardProgress('scoring');
        };

        const computeOverallFromGrades = function(gradeValues) {
          const totals = [];
          Object.keys(gradeValues).forEach(function(key) {
            if (!scopeSelected(key)) {
              return;
            }
            const risk = gradeValues[key];
            const bounds = riskScoreMap[risk];
            if (!bounds) {
              return;
            }
            const midpoint = (parseFloat(bounds.min) + parseFloat(bounds.max)) / 2;
            if (Number.isNaN(midpoint)) {
              return;
            }
            const adjusted = key === 'wireless' ? midpoint * 0.9 : midpoint;
            totals.push(adjusted);
          });
          if (!totals.length) {
            return null;
          }
          const average = totals.reduce(function(sum, value) { return sum + value; }, 0) / totals.length;
          return scoreToRisk(Math.round(average * 10) / 10);
        };

        const renderGradeFields = function() {
          const container = document.getElementById('workbook-grades-fields');
          if (!container) {
            return;
          }
          container.innerHTML = '';
          const fragment = document.createDocumentFragment();
          const calculatedGrades = {};
          const computedTotals = updateTotalsAndGrades();
          Object.keys(scopingState).forEach(function(categoryKey) {
            if (!scopeSelected(categoryKey)) {
              return;
            }
            const card = document.createElement('div');
            card.className = 'form-group';
            const label = document.createElement('label');
            label.className = 'font-weight-bold';
            label.setAttribute('for', 'grade-' + categoryKey);
            const categoryConfig = scopingConfig[categoryKey] || {};
            label.textContent = (categoryConfig.label || titleize(categoryKey)) + ' Grade';
            const select = document.createElement('select');
            select.className = 'form-control workbook-grade-select';
            select.id = 'grade-' + categoryKey;
            select.setAttribute('data-category', categoryKey);
            const currentGrade = (workbookState.report_card && workbookState.report_card[categoryKey])
              || (computedTotals && computedTotals[categoryKey] && computedTotals[categoryKey].grade) || '';
            riskLabels.forEach(function(labelValue) {
              const option = document.createElement('option');
              option.value = labelValue;
              option.textContent = labelValue;
              if (labelValue === currentGrade) {
                option.selected = true;
              }
              select.appendChild(option);
            });
            if (!currentGrade) {
              const placeholder = document.createElement('option');
              placeholder.value = '';
              placeholder.textContent = 'Select grade';
              placeholder.selected = true;
              select.insertBefore(placeholder, select.firstChild);
            }
            select.addEventListener('change', function() {
              updateWorkbookCardProgress('grades');
            });
            calculatedGrades[categoryKey] = currentGrade;
            card.appendChild(label);
            card.appendChild(select);
            fragment.appendChild(card);
          });
          const overallWrapper = document.createElement('div');
          overallWrapper.className = 'form-group';
          const overallLabel = document.createElement('label');
          overallLabel.className = 'font-weight-bold';
          overallLabel.setAttribute('for', 'grade-overall');
          overallLabel.textContent = 'Overall';
          const overallSelect = document.createElement('select');
          overallSelect.className = 'form-control workbook-grade-select';
          overallSelect.id = 'grade-overall';
          overallSelect.setAttribute('data-category', 'overall');
          const existingOverall = workbookState.report_card && workbookState.report_card.overall;
          const computedOverall = computeOverallFromGrades(calculatedGrades);
          riskLabels.forEach(function(labelValue) {
            const option = document.createElement('option');
            option.value = labelValue;
            option.textContent = labelValue;
            if (labelValue === (existingOverall || computedOverall)) {
              option.selected = true;
            }
            overallSelect.appendChild(option);
          });
          if (!existingOverall && !computedOverall) {
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select grade';
            placeholder.selected = true;
            overallSelect.insertBefore(placeholder, overallSelect.firstChild);
          }
          overallSelect.addEventListener('change', function() {
            updateWorkbookCardProgress('grades');
          });
          overallWrapper.appendChild(overallLabel);
          overallWrapper.appendChild(overallSelect);
          fragment.appendChild(overallWrapper);
          container.appendChild(fragment);
          updateWorkbookCardProgress('grades');
        };

        const getCsrfToken = function() {
          const cookieString = document.cookie || '';
          const cookies = cookieString.split(';');
          for (let i = 0; i < cookies.length; i += 1) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
              return decodeURIComponent(cookie.substring('csrftoken='.length));
            }
          }
          return null;
        };

        const submitWorkbookUpdate = function(payload, onSuccess) {
          if (!workbookUpdateUrl) {
            return;
          }
          fetch(workbookUpdateUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken() || ''
            },
            body: JSON.stringify(payload || {})
          }).then(function(response) {
            if (!response.ok) {
              throw new Error('Unable to update workbook data');
            }
            return response.json();
          }).then(function(data) {
            if (data && data.workbook_data) {
              Object.assign(workbookState, data.workbook_data);
            }
            if (data && data.data_artifacts) {
              Object.assign(dataArtifactsState, data.data_artifacts);
            }
            renderGeneralFields();
            renderScoringGroups();
            renderGradeFields();
            renderAreaCards();
            if (typeof onSuccess === 'function') {
              onSuccess();
            }
          }).catch(function(error) {
            console.error(error);
            alert('Unable to save workbook data.');
          });
        };

        const saveGeneralButton = document.getElementById('saveGeneralWorkbookData');
        if (saveGeneralButton) {
          saveGeneralButton.addEventListener('click', function() {
            const payload = {};
            workbookGeneralFieldConfig.forEach(function(field) {
              if (!scopeSelected(field.scope)) {
                return;
              }
              const input = document.getElementById('workbook-general-' + field.key);
              if (!input) {
                return;
              }
              if (!payload.general) {
                payload.general = {};
              }
              payload.general[field.key] = input.value || null;
            });
            submitWorkbookUpdate(payload, function() {
              $('#workbookGeneralModal').modal('hide');
            });
          });
        }

        const saveScoringButton = document.getElementById('saveScoringWorkbookData');
        if (saveScoringButton) {
          saveScoringButton.addEventListener('click', function() {
            const payload = {scores: getScoresFromInputs()};
            submitWorkbookUpdate(payload, function() {
              $('#workbookScoringModal').modal('hide');
            });
          });
        }

        const saveGradesButton = document.getElementById('saveGradeWorkbookData');
        if (saveGradesButton) {
          saveGradesButton.addEventListener('click', function() {
            const selects = document.querySelectorAll('.workbook-grade-select');
            const payload = {grades: {}};
            selects.forEach(function(select) {
              const category = select.getAttribute('data-category');
              if (!category) {
                return;
              }
              payload.grades[category] = select.value || null;
            });
            submitWorkbookUpdate(payload, function() {
              $('#workbookGradesModal').modal('hide');
            });
          });
        }

        const resetButton = document.getElementById('resetGradeValues');
        if (resetButton) {
          resetButton.addEventListener('click', function() {
            renderGradeFields();
          });
        }

        const adjustButton = document.getElementById('adjustGradeOverall');
        if (adjustButton) {
          adjustButton.addEventListener('click', function() {
            const selects = document.querySelectorAll('.workbook-grade-select');
            const grades = {};
            selects.forEach(function(select) {
              const category = select.getAttribute('data-category');
              if (!category || category === 'overall') {
                return;
              }
              grades[category] = select.value || null;
            });
            const overall = computeOverallFromGrades(grades);
            const overallSelect = document.getElementById('grade-overall');
            if (overall && overallSelect) {
              overallSelect.value = overall;
            }
            updateWorkbookCardProgress('grades');
          });
        }

        renderGeneralFields();
        renderAreaCards();
        renderScoringGroups();
        renderGradeFields();
        buildRiskLegend();

        $(document).on('hidden.bs.modal', '.modal', function() {
          cleanupModalBackdrops();
        });
      });
    })(jQuery);

    function initialiseCalendar() {
      const calendarEl = document.getElementById('project-calendar');
      if (calendarEl && typeof FullCalendar !== 'undefined') {
        const startDate = calendarEl.getAttribute('data-start');
        const endDate = calendarEl.getAttribute('data-end');
        const options = {
          initialView: 'dayGridMonth',
          height: 'auto',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
          },
          events: []
        };
        if (startDate) {
          let adjustedEnd = endDate;
          if (endDate) {
            const end = new Date(endDate);
            end.setDate(end.getDate() + 1);
            adjustedEnd = end.toISOString().slice(0, 10);
          }
          options.events.push({
            title: '{{ project.project_type|escapejs }}',
            start: startDate,
            end: adjustedEnd,
            allDay: true,
            display: 'block'
          });
        }
        const calendar = new FullCalendar.Calendar(calendarEl, options);
        calendar.render();
      }
    }

    function handleMultipleTextInputs() {
      document.addEventListener('click', function(event) {
        const addButton = event.target.closest('.multiple-text-input__add');
        if (addButton) {
          const container = addButton.closest('.multiple-text-input');
          const rows = container.querySelector('.multiple-text-input__rows');
          const firstRow = rows.querySelector('.multiple-text-input__row');
          if (firstRow) {
            const newRow = firstRow.cloneNode(true);
            const input = newRow.querySelector('input');
            if (input) {
              input.value = '';
            }
            const removeButton = newRow.querySelector('.multiple-text-input__remove');
            if (removeButton) {
              removeButton.style.display = '';
            }
            rows.appendChild(newRow);
            rows.querySelectorAll('.multiple-text-input__remove').forEach(function(button) {
              button.style.display = rows.children.length > 1 ? '' : 'none';
            });
          }
        }
        const removeButton = event.target.closest('.multiple-text-input__remove');
        if (removeButton) {
          const row = removeButton.closest('.multiple-text-input__row');
          const rows = row && row.parentNode;
          if (rows && rows.children.length > 1) {
            row.remove();
          }
          if (rows && rows.children.length === 1) {
            const remaining = rows.querySelector('.multiple-text-input__remove');
            if (remaining) {
              remaining.style.display = 'none';
            }
          }
        }
      });
    }

    function toggleSegmentationDetails() {
      const toggle = document.getElementById('id_wireless_segmentation_tested');
      const target = document.querySelector('[data-segmentation-target]');
      if (target) {
        if (toggle && toggle.checked) {
          target.classList.remove('d-none');
        } else {
          target.classList.add('d-none');
        }
      }
    }

    function toggleMasterpassDetails() {
      const target = document.querySelector('[data-masterpass-target]');
      if (!target) {
        return;
      }
      const selected = document.querySelector('input[name="wireless_psk_masterpass"]:checked');
      if (selected && selected.value === 'yes') {
        target.classList.remove('d-none');
      } else {
        target.classList.add('d-none');
      }
    }

    function toggleScopeFollowup() {
      const control = document.querySelector('[data-scope-control]');
      if (!control) {
        return;
      }
      const checkboxes = control.querySelectorAll('input[name="assessment_scope"]');
      let cloudSelected = false;
      let internalSelected = false;
      checkboxes.forEach(function(checkbox) {
        if (!checkbox.checked) {
          return;
        }
        if (checkbox.value === 'cloud') {
          cloudSelected = true;
        }
        if (checkbox.value === 'internal') {
          internalSelected = true;
        }
      });

      const followup = document.querySelector('[data-scope-cloud-followup]');
      if (followup) {
        if (cloudSelected) {
          followup.classList.remove('d-none');
        } else {
          followup.classList.add('d-none');
          const radios = followup.querySelectorAll('input[type="radio"]');
          radios.forEach(function(radio) {
            radio.checked = false;
          });
        }
      }

      const passwordFollowup = document.querySelector('[data-password-followup]');
      if (passwordFollowup) {
        if (cloudSelected || internalSelected) {
          passwordFollowup.classList.remove('d-none');
        } else {
          passwordFollowup.classList.add('d-none');
          const radios = passwordFollowup.querySelectorAll('input[type="radio"]');
          radios.forEach(function(radio) {
            radio.checked = false;
          });
        }
      }
    }

    function toggleFirstCAFollowup() {
      const control = document.querySelector('[data-first-ca-control]');
      const followup = document.querySelector('[data-first-ca-followup]');
      if (!control || !followup) {
        return;
      }
      const selected = control.querySelector('input[name="general_first_ca"]:checked');
      if (selected && selected.value === 'no') {
        followup.classList.remove('d-none');
      } else {
        followup.classList.add('d-none');
        const radios = followup.querySelectorAll('input[type="radio"]');
        radios.forEach(function(radio) {
          radio.checked = false;
        });
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      initialiseCalendar();
      handleMultipleTextInputs();
      toggleSegmentationDetails();
      toggleMasterpassDetails();
      toggleScopeFollowup();
      toggleFirstCAFollowup();
      restoreProjectScrollPosition();
    });

    document.addEventListener('change', function(event) {
      if (event.target && event.target.id === 'id_wireless_segmentation_tested') {
        toggleSegmentationDetails();
      }
      if (event.target && event.target.name === 'wireless_psk_masterpass') {
        toggleMasterpassDetails();
      }
      if (event.target && event.target.name === 'assessment_scope') {
        toggleScopeFollowup();
      }
      if (event.target && event.target.name === 'general_first_ca') {
        toggleFirstCAFollowup();
      }
    });

    window.addEventListener('pageshow', function(event) {
      if (event && event.persisted) {
        restoreProjectScrollPosition();
      }
    });
  </script>
{% endblock %}

{% include "confirm_delete_modal.html" %}

{% if project_extra_fields_spec %}
  {% for field_spec in project_extra_fields_spec %}
    {% include "user_extra_fields/extra_field_modal.html" with extra_fields=project.extra_fields field_spec=field_spec %}
  {% endfor %}
{% endif %}
